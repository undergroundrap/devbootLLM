<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>devbootLLM - AI-Assisted Bootcamp</title>
    <link rel="stylesheet" href="css/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs/editor/editor.main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Markdown + Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/python.min.js"></script>
    <style>
        /* Base styles and custom scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #131314; /* Main Gemini BG */
            color: #e3e3e3;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #131314; }
        ::-webkit-scrollbar-thumb { background: #3c4043; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5f6368; }
        
        /* Theme colors */
        .gemini-bg-main { background-color: #131314; }
        .gemini-bg-secondary { background-color: #1e1f20; }
        .gemini-bg-tertiary { background-color: #282a2c; }
        .gemini-border { border-color: #3c4043; }
        .editor-bg { background-color: #1E1E1E; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .toast-in { animation: toastIn 0.3s ease-out forwards; }
        .toast-out { animation: toastOut 0.3s ease-in forwards; }
        
        /* Custom button styles */
        .btn {
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            filter: brightness(1.1);
        }
        .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.5); /* Ring effect */
        }
        .btn-primary { background-color: #7c3aed; color: white; }
        .btn-primary:hover { background-color: #8b5cf6; }
        .btn-secondary { background-color: #3c4043; color: #e3e3e3; }
        .btn-secondary:hover { background-color: #5f6368; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #ef4444; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #10b981; }
        .btn-info { background-color: #0284c7; color: white; }
        .btn-info:hover { background-color: #0ea5e9; }
        .btn-warning { background-color: #d97706; color: white; }
        .btn-warning:hover { background-color: #f59e0b; }
        .btn:disabled {
            background-color: #282a2c;
            color: #6b7280;
            cursor: not-allowed;
            box-shadow: none;
            filter: brightness(1);
        }

        .card-hover {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        .card-hover:hover {
            transform: translateY(-0.25rem);
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            background-color: #282a2c;
        }
        
        /* Modal Styling */
        .modal-container.hidden { pointer-events: none; }
        .modal-bg.opacity-0 { opacity: 0; }
        .modal-content.opacity-0 { opacity: 0; transform: scale(0.95) translateY(1rem); }

        /* Code Block Styling */
        .code-block-wrapper {
            position: relative;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .code-block-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(60, 64, 67, 0.7);
            color: #e3e3e3;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.5;
            z-index: 10;
        }
        .code-block-wrapper:hover .code-block-copy-btn {
            opacity: 1;
            background-color: #5f6368;
        }
        .code-block-copy-btn:hover {
            background-color: #7c3aed;
        }

        /* AI Input Textarea Styling */
        #ai-input {
            min-height: 40px;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.5;
        }
        #ai-input::-webkit-scrollbar {
            width: 6px;
        }
        #ai-input::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        #ai-input::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.5);
            border-radius: 3px;
        }
        #ai-input::-webkit-scrollbar-thumb:hover {
            background: rgba(124, 58, 237, 0.8);
        }

        /* Quick Action Buttons */
        .quick-action-btn {
            background: rgba(60, 64, 67, 0.5);
            border: 1px solid rgba(124, 58, 237, 0.3);
            color: #c4b5fd;
            padding: 0.35rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .quick-action-btn:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: rgba(124, 58, 237, 0.6);
            color: #ddd6fe;
        }
        .quick-action-btn i {
            margin-right: 0.25rem;
        }

        /* Markdown styling within chat bubbles */
        .markdown-body {
            color: #e5e7eb; /* gray-200 */
            line-height: 1.6;
        }
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4,
        .markdown-body h5,
        .markdown-body h6 {
            color: #ffffff;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .markdown-body h1 { font-size: 1.5rem; }
        .markdown-body h2 { font-size: 1.25rem; }
        .markdown-body h3 { font-size: 1.125rem; }
        .markdown-body p { margin: 0.5rem 0; }
        .markdown-body ul,
        .markdown-body ol { margin-left: 1.25rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .markdown-body li { margin: 0.25rem 0; }
        .markdown-body a { color: #93c5fd; text-decoration: underline; }
        .markdown-body blockquote {
            border-left: 4px solid #7c3aed;
            padding-left: 0.75rem;
            color: #c7c7c7;
            margin: 0.5rem 0;
        }
        .markdown-body pre {
            background: rgba(0,0,0,0.5);
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .markdown-body code {
            background: #374151; /* gray-700 */
            color: #c4b5fd; /* violet-300 */
            border-radius: 0.375rem;
            padding: 0 0.25rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85em;
        }

        /* Tutorial Keyword Highlighting */
        .tutorial-keyword,
        code:not(pre code) {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
            color: #c4b5fd;
            border: 1px solid rgba(124, 58, 237, 0.4);
            border-radius: 0.375rem;
            padding: 0.125rem 0.5rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9em;
            font-weight: 500;
            white-space: nowrap;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        pre code {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
            display: block !important;
            white-space: pre !important;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5rem 0;
        }
        .markdown-body th,
        .markdown-body td {
            border: 1px solid #3c4043;
            padding: 0.5rem;
        }
        .markdown-body th { background: #1e1f20; }

        /* AI Typing Indicator */
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        /* Resizer style */
        #resizer {
            flex-shrink: 0;
            background-color: #3c4043;
            width: 5px;
            cursor: col-resize;
            transition: background-color 0.2s ease;
        }
        #resizer:hover, #resizer.resizing {
            background-color: #7c3aed;
        }

        /* Sidebar Styles */
        #lesson-sidebar {
            transition: width 0.3s ease-in-out;
            width: 280px;
            flex-shrink: 0;
        }
        #lesson-sidebar.hidden {
            width: 0;
        }
        .sidebar-lesson-item.active {
            background-color: #7c3aed;
            color: white;
        }
         .sidebar-lesson-item.active .text-gray-400 {
            color: #d1d5db;
           }

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Force dark styling for native select */
        #ai-model, #ai-provider {
            background-color: #282a2c !important; /* gemini-bg-tertiary */
            color: #e5e7eb !important; /* gray-200 */
            border-color: #3c4043 !important; /* gemini-border */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        #ai-model option, #ai-provider option {
            background-color: #1e1f20; /* gemini-bg-secondary */
            color: #e5e7eb;
        }
        /* Hide default arrow in old IE */
        #ai-model::-ms-expand, #ai-provider::-ms-expand { display: none; }
    </style>
</head>
<body class="antialiased">

    <div id="app-container">

        <!-- LANDING PAGE VIEW -->
        <div id="landing-page-view">
            <div class="flex flex-col min-h-screen">
                <header class="gemini-bg-secondary border-b gemini-border shadow-lg z-20 flex-shrink-0">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-brain text-3xl text-violet-400"></i>
                                <span class="text-2xl font-bold text-slate-100 tracking-tight">devbootLLM</span>
                            </div>
                            <nav class="hidden md:flex items-center space-x-6">
                                <a href="#courses" class="text-gray-300 hover:text-violet-400 transition-colors">Courses</a>
                                <a href="#" class="text-gray-300 hover:text-violet-400 transition-colors">About</a>
                                <a href="#" class="text-gray-300 hover:text-violet-400 transition-colors">Contact</a>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="flex-grow">
                    <section class="py-20 sm:py-28">
                        <div class="max-w-4xl mx-auto text-center px-4">
                            <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-tighter mb-4">
                                The Self-Taught Developer's <span class="text-violet-400">AI Co-Pilot</span>
                            </h1>
                            <p class="text-lg md:text-xl text-gray-400 max-w-2xl mx-auto mb-8">
                                Master programming with a hands-on, AI-assisted bootcamp. Learn at your own pace, with an intelligent assistant to guide you every step of the way.
                            </p>
                            <a href="#courses" id="start-journey-btn" class="btn btn-primary text-lg">
                                <span>Start Your Journey</span>
                                <i class="fa-solid fa-arrow-down"></i>
                            </a>
                        </div>
                    </section>
                    <section id="courses" class="py-16 sm:py-20 gemini-bg-secondary">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="text-center mb-12">
                                <h2 class="text-3xl md:text-4xl font-bold text-white">Available Learning Paths</h2>
                                <p class="text-gray-400 mt-2">Choose a language to begin your self-taught adventure.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                <!-- Java Course Card -->
                                <div class="gemini-bg-tertiary border gemini-border rounded-xl p-8 flex flex-col card-hover">
                                    <div class="flex-shrink-0 mb-6"><i class="fab fa-java text-6xl text-sky-400"></i></div>
                                    <div class="flex-grow">
                                        <h3 class="text-2xl font-bold text-white mb-2">Java Fundamentals</h3>
                                        <p class="text-gray-400 mb-6">Build a solid foundation in Java, one of the world's most popular programming languages. Perfect for beginners.</p>
                                    </div>
                                    <div class="mt-auto">
                                        <button id="start-java-course-btn" class="btn btn-primary w-full">
                                            <span>Start Learning</span>
                                            <i class="fa-solid fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Python Course Card -->
                                <div class="gemini-bg-tertiary border gemini-border rounded-xl p-8 flex flex-col card-hover">
                                     <div class="flex-shrink-0 mb-6"><i class="fab fa-python text-6xl text-green-400"></i></div>
                                    <div class="flex-grow">
                                        <h3 class="text-2xl font-bold text-white mb-2">Python Essentials</h3>
                                        <p class="text-gray-400 mb-6">Discover the simplicity and power of Python. Ideal for data science, web development, and automation.</p>
                                    </div>
                                    <div class="mt-auto">
                                        <button id="start-python-course-btn" class="btn btn-primary w-full">
                                            <span>Start Learning</span>
                                            <i class="fa-solid fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- More Courses Card -->
                                <div class="border-2 border-dashed gemini-border rounded-xl p-8 flex flex-col items-center justify-center text-center text-gray-500 card-hover">
                                    <i class="fa-solid fa-plus text-4xl mb-4"></i>
                                    <h3 class="text-xl font-bold">More Paths Coming</h3>
                                    <p class="mt-2">We're working hard to bring you more exciting learning journeys!</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </main>
                <footer class="gemini-bg-secondary border-t gemini-border mt-auto">
                    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-400">
                        <p>&copy; 2025 devbootLLM. All rights reserved.</p>
                    </div>
                </footer>
            </div>
        </div>

        <!-- LEARNING PAGE VIEW -->
        <div id="learning-page-view" class="hidden">
            <div id="app" class="flex flex-col h-screen">
                <canvas id="confetti-canvas"></canvas>
                <header class="gemini-bg-secondary border-b gemini-border shadow-lg z-20 flex-shrink-0">
                    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center space-x-3">
                                <button id="sidebar-toggle-btn" class="btn btn-secondary !p-2.5" title="Toggle Lesson Sidebar">
                                    <i class="fa-solid fa-bars"></i>
                                </button>
                                <button id="home-link" class="flex items-center space-x-3 group" title="Back to Home">
                                    <i class="fa-solid fa-brain text-3xl text-violet-400 group-hover:text-violet-300 transition-colors"></i>
                                    <span class="text-2xl font-bold text-slate-100 tracking-tight group-hover:text-white transition-colors">devbootLLM</span>
                                </button>
                            </div>
                            <div id="progress-container" class="flex-grow mx-8 lg:mx-16 flex items-center space-x-4">
                                 <span id="progress-label" class="text-sm font-medium text-gray-400 whitespace-nowrap" title="700 total lessons (lesson IDs go up to 735 with intentional gaps for bridging lessons)"></span>
                                 <div class="w-full bg-[#3c4043] rounded-full h-2.5">
                                     <div id="progress-bar" class="bg-violet-500 h-2.5 rounded-full transition-all duration-500 ease-out"></div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="hidden sm:flex items-center space-x-2">
                                    <label class="text-sm text-gray-300">Course:</label>
                                    <select id="course-select" class="appearance-none gemini-bg-tertiary border gemini-border text-gray-200 rounded-md px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-violet-500 focus:border-violet-500 transition-colors">
                                        <option value="java">Java</option>
                                        <option value="python">Python</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div id="db-status-light" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                                    <span id="db-status-text" class="text-sm font-medium text-gray-300">Connecting...</span>
                                </div>
                                <button id="reset-progress-btn" class="btn btn-secondary !p-2" title="Reset all progress">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
                <main class="flex-grow flex flex-row overflow-hidden">
                    <!-- Lesson Sidebar -->
                    <aside id="lesson-sidebar" class="gemini-bg-secondary border-r gemini-border flex flex-col overflow-y-auto">
                        <div class="p-4 border-b gemini-border">
                            <h3 id="course-title" class="text-lg font-bold text-white">Java Fundamentals</h3>
                            <label for="lesson-filter" class="block mt-3 text-xs uppercase tracking-wide text-gray-400">Level Filter</label>
                            <select id="lesson-filter" class="mt-1 w-full bg-[#1e1f20] border gemini-border rounded-md text-sm p-2 focus:outline-none">
                                <option value="all">All Lessons (1-700)</option>
                                <option value="beginner">Beginner (1-104 + Bridges)</option>
                                <option value="intermediate">Intermediate (105-214 + Bridges)</option>
                                <option value="advanced">Advanced (215-374 + Bridges)</option>
                                <option value="expert">Expert (375-532 + Bridges)</option>
                                <option value="enterprise">Enterprise (533-639 + Bridges)</option>
                                <option value="faang">FAANG Interview Prep (640-689)</option>
                                <option value="jobready">Job Ready (690-700)</option>
                            </select>
                            <label for="tag-filter" class="block mt-3 text-xs uppercase tracking-wide text-gray-400">Tag</label>
                            <select id="tag-filter" class="mt-1 w-full bg-[#1e1f20] border gemini-border rounded-md text-sm p-2 focus:outline-none">
                                <option value="all">All Tags</option>
                            </select>
                            <label for="lesson-search" class="block mt-3 text-xs uppercase tracking-wide text-gray-400">Search</label>
                            <input id="lesson-search" type="text" placeholder="Search by title, description, or #number..." class="mt-1 w-full bg-[#1e1f20] border gemini-border rounded-md text-sm p-2 focus:outline-none" />
                        </div>
                        <nav id="lesson-list" class="flex-grow p-2 space-y-1"></nav>
                    </aside>

                    <!-- Main Content -->
                    <div class="flex-grow flex flex-row overflow-hidden">
                        <!-- Left Panel: Lesson and Editor -->
                        <div id="left-panel" class="w-3/5 flex flex-col border-r gemini-border h-full">
                            <div id="lesson-panel" class="p-6 gemini-bg-secondary border-b gemini-border fade-in flex-shrink-0">
                                <!-- Lesson Title Box -->
                                <div class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-lg p-4 mb-4">
                                    <h1 id="lesson-title" class="text-2xl font-bold text-white text-center mb-0"></h1>
                                </div>

                                <p id="lesson-description" class="text-gray-400 mb-3"></p>
                                <div id="lesson-tags" class="mb-5 flex flex-wrap gap-2"></div>

                                <!-- Centered View Tutorial Button -->
                                <div class="flex justify-center mb-4">
                                    <button id="view-tutorial-btn" class="btn btn-info" title="View the tutorial for this lesson"><i class="fa-solid fa-book-open"></i><span>View Tutorial</span></button>
                                </div>

                                <!-- Navigation Buttons -->
                                <div class="flex justify-between items-center">
                                    <button id="prev-lesson-btn" class="btn btn-secondary" title="Go to the previous lesson"><i class="fa-solid fa-arrow-left"></i><span>Previous</span></button>
                                    <span id="lesson-status" class="text-sm font-semibold text-gray-500"></span>
                                    <button id="next-lesson-btn" class="btn btn-primary" title="Go to the next lesson"><span>Next</span><i class="fa-solid fa-arrow-right"></i></button>
                                </div>
                            </div>
                            <div class="flex-grow flex flex-col relative editor-bg">
                                <div id="editor-container" class="flex-grow relative">
                                    <div id="editor-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 text-lg">
                                        <i class="fas fa-spinner fa-spin mr-3"></i> Loading Editor...
                                    </div>
                                    <div id="editor" class="absolute inset-0 opacity-0 transition-opacity duration-500"></div>
                                </div>
                                <div class="flex items-center justify-between space-x-4 p-3 gemini-bg-secondary border-t gemini-border flex-shrink-0">
                                    <div class="flex items-center space-x-2">
                                         <button id="search-btn" class="btn btn-secondary !p-2.5" title="Search in code (Ctrl+F)" aria-label="Search code"><i class="fa-solid fa-magnifying-glass"></i></button>
                                         <button id="format-btn" class="btn btn-secondary !p-2.5" title="Format code (Shift+Alt+F)" aria-label="Format code"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button id="solve-btn" class="btn btn-warning" title="Show the solution for this lesson"><i class="fa-solid fa-lightbulb"></i><span>Solve Lesson</span></button>
                                        <button id="reset-btn" class="btn btn-secondary" title="Reset the code to its original state"><i class="fa-solid fa-arrow-rotate-left"></i><span>Reset Code</span></button>
                                        <button id="run-btn" class="btn btn-success text-lg py-2.5 px-8" title="Check your code (Ctrl+Enter)"><i class="fa-solid fa-play"></i><span>Check Code</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Resizer -->
                        <div id="resizer"></div>
                        <!-- Right Panel: Console and AI -->
                        <div id="right-panel" class="w-2/5 flex flex-col gemini-bg-main h-full">
                            <div class="h-1/3 flex flex-col border-b gemini-border">
                                <div class="flex items-center justify-between p-4 flex-shrink-0 text-gray-300 border-b gemini-border gemini-bg-tertiary">
                                    <h2 class="text-lg font-semibold flex items-center"><i class="fa-solid fa-terminal w-5 mr-3"></i>Console</h2>
                                    <button id="clear-console-btn" class="text-gray-400 hover:text-white" title="Clear console log"><i class="fa-solid fa-eraser"></i></button>
                                </div>
                                <div id="console-output" class="bg-[#131314] p-4 text-sm font-mono flex-grow overflow-y-auto space-y-1"></div>
                            </div>
                            <div class="h-2/3 flex flex-col">
                                <h2 class="text-lg font-semibold p-4 flex items-center flex-shrink-0 text-gray-300 border-b gemini-border gemini-bg-tertiary"><i class="fa-solid fa-robot w-5 mr-3 text-violet-400"></i>AI Assistant</h2>
                                <div id="ai-chat" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                                <div class="p-4 border-t gemini-border gemini-bg-main flex-shrink-0">
                                    <div class="flex items-center justify-center mb-2 text-xs text-gray-400">
                                        <div class="flex items-center space-x-3">
                                            <div class="flex items-center space-x-2">
                                                <label for="ai-provider" class="mr-1">Provider:</label>
                                                <div class="relative inline-block">
                                                    <select id="ai-provider" class="appearance-none gemini-bg-tertiary border gemini-border text-gray-200 rounded-md px-3 py-2 pr-8 text-xs focus:outline-none focus:ring-1 focus:ring-violet-500 focus:border-violet-500 transition-colors"></select>
                                                    <i class="fa-solid fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label for="ai-model" class="mr-1">Model:</label>
                                                <div class="relative inline-block">
                                                    <select id="ai-model" class="appearance-none gemini-bg-tertiary border gemini-border text-gray-200 rounded-md px-3 py-2 pr-8 text-xs focus:outline-none focus:ring-1 focus:ring-violet-500 focus:border-violet-500 transition-colors"></select>
                                                    <i class="fa-solid fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                                </div>
                                                <button id="ai-model-refresh-btn" class="text-gray-400 hover:text-gray-200" title="Refresh models" aria-label="Refresh models">
                                                    <i class="fa-solid fa-rotate"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Quick Action Buttons -->
                                    <div class="flex flex-wrap justify-center gap-2 mb-2">
                                        <button class="quick-action-btn" id="hint-btn" title="Get a subtle hint">
                                            <i class="fa-solid fa-lightbulb"></i>Hint
                                        </button>
                                        <button class="quick-action-btn" id="explain-btn" title="Understand the core concept">
                                            <i class="fa-solid fa-book"></i>Explain
                                        </button>
                                        <button class="quick-action-btn" id="debug-btn" title="Find issues in your code">
                                            <i class="fa-solid fa-bug"></i>Debug
                                        </button>
                                        <button class="quick-action-btn" id="best-practices-btn" title="Learn professional patterns">
                                            <i class="fa-solid fa-star"></i>Best Practices
                                        </button>
                                    </div>
                                    <div class="flex items-start bg-gemini-bg-tertiary rounded-lg border gemini-border focus-within:border-violet-500 transition-colors">
                                        <textarea id="ai-input" class="flex-grow bg-transparent border-none p-3 focus:outline-none focus:ring-0 text-sm text-gray-200 resize-none" placeholder="Ask for a hint or explanation..." rows="1"></textarea>
                                        <button id="ai-clear-btn" class="btn btn-secondary m-1.5 py-1.5 px-3 self-end" title="Clear chat" aria-label="Clear chat"><i class="fa-solid fa-trash"></i></button>
                                        <button id="ai-ask-btn" class="btn btn-primary m-1.5 py-1.5 px-3 self-end" title="Ask the AI Assistant" aria-label="Ask AI Assistant"><i id="ai-ask-icon" class="fa-solid fa-paper-plane"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                
                <!-- Tutorial Modal -->
                <div id="tutorial-modal" class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                    <div id="tutorial-modal-bg" class="modal-bg absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
                    <div id="tutorial-modal-content" class="modal-content gemini-bg-tertiary border gemini-border rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 opacity-0 scale-95">
                        <div class="flex items-center justify-between p-4 border-b gemini-border flex-shrink-0">
                            <h2 id="tutorial-title" class="text-xl font-bold text-white flex items-center"></h2>
                            <button id="close-tutorial-btn" class="text-gray-400 hover:text-white text-2xl font-bold leading-none" title="Close Tutorial" aria-label="Close Tutorial">&times;</button>
                        </div>
                        <div id="tutorial-body" class="p-6 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Confirmation Modal -->
                <div id="confirm-modal" class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
                    <div id="confirm-modal-bg" class="modal-bg absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
                    <div id="confirm-modal-content" class="modal-content gemini-bg-tertiary border gemini-border rounded-xl shadow-2xl w-full max-w-md flex flex-col transform transition-all duration-300 opacity-0 scale-95">
                        <div class="p-6">
                            <h3 id="confirm-modal-title" class="text-lg font-bold text-white mb-2">Are you sure?</h3>
                            <p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
                        </div>
                        <div class="flex justify-end space-x-3 p-4 bg-gemini-bg-secondary/50 rounded-b-xl">
                            <button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                            <button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-3"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs/loader.js"></script>
    
    <!-- Firebase SDK -->
    <script>
        // Import Firebase modules - REMOVED

        document.addEventListener('DOMContentLoaded', () => {

            // --- LocalStorage Service: Handles all local storage interactions ---
            class LocalStorageService {
                constructor(appController) {
                    this.appController = appController;
                    this.storageKey = appController && typeof appController.getStorageKey === 'function'
                        ? appController.getStorageKey()
                        : 'devbootllm-java-progress';
                }

                init() {
                    // Simulate async initialization and load data
                    this.appController.setDbStatus('syncing', 'Loading...');
                    setTimeout(() => {
                        this.loadData();
                    }, 100); // Small delay to allow UI to render
                }

                loadData() {
                    try {
                        const savedState = localStorage.getItem(this.storageKey);
                        const state = savedState ? JSON.parse(savedState) : null;
                        this.appController.isDbReady = true;
                        this.appController.loadStateFromDb(state);
                        this.appController.setDbStatus('connected', 'Ready');
                    } catch (error) {
                        console.error("Failed to load state from localStorage:", error);
                        this.appController.isDbReady = true;
                        this.appController.loadStateFromDb(null); // Load default state on error
                        this.appController.setDbStatus('error', 'Load Failed');
                    }
                }

                saveData(state) {
                    try {
                        this.appController.setDbStatus('syncing', 'Saving...');
                        localStorage.setItem(this.storageKey, JSON.stringify(state));
                        // Add a small delay to show the "Saving..." status
                        setTimeout(() => {
                             if (this.appController.elements.dbStatusText.textContent === 'Saving...'){
                                this.appController.setDbStatus('connected', 'Saved');
                            }
                        }, 1000);
                    } catch (error) {
                        console.error("Failed to save state to localStorage:", error);
                        this.appController.showToast('Save failed!', 'error');
                        this.appController.setDbStatus('error', 'Save Failed');
                    }
                }

                resetProgress() {
                    try {
                        localStorage.removeItem(this.storageKey);
                        this.appController.showToast('Progress reset successfully!', 'success');
                        // Instead of a full reload, just re-initialize the state
                        this.appController.loadStateFromDb(null);
                    } catch (error) {
                        console.error("Error resetting progress:", error);
                        this.appController.showToast('Reset failed!', 'error');
                    }
                }
            }


            // --- Main Application Controller ---
            class LearningAppController {
                constructor() {
                    this.editor = null;
                    this.storageService = null;
                    this.chatHistory = [];
                    this.currentLessonIndex = 0;
                    this.userCode = {};
                    this.lessonCompletion = {};
                    this.elements = {};
                    this.saveTimeout = null;
                    this.isDbReady = false;
                    this.confettiParticles = [];
                    this.currentTrack = localStorage.getItem('courseTrack') || 'java';
                    
                    // Rely entirely on external JSON files
                    this.lessons = [];
                    this.lessonFilter = localStorage.getItem(`lessonFilter-${this.currentTrack}`) || 'all';
                    this.lessonSearchQuery = localStorage.getItem(`lessonSearch-${this.currentTrack}`) || '';
                    this.tagFilter = localStorage.getItem(`tagFilter-${this.currentTrack}`) || 'all';

                    // Debounced sidebar updater to reduce UI thrash on input/filter changes
                    this.populateLessonSidebarDebounced = this.debounce(() => this.populateLessonSidebar(), 150);
                }

                async init() {
                    this.cacheDOMElements();
                    this.initCourseSelect();
                    this.storageService = new LocalStorageService(this);
                    // Load lessons for selected course before state init
                    await this.loadLessonsForTrack(this.currentTrack);
                    this.updateCourseTitle();
                    this.initLessonFilter();
                    this.storageService.init();
                    this.initEditor();
                    this.addEventListeners();
                    this.addResizerLogic();
                    this.resetUI();
                    this.initProviderSelect();
                    this.initOllamaModels();
                    this.initLessonSearch();
                }

                cacheDOMElements() {
                    const ids = [
                        'lesson-title', 'lesson-description', 'prev-lesson-btn', 'next-lesson-btn',
                        'run-btn', 'reset-btn', 'console-output', 'ai-ask-btn', 'ai-ask-icon',
                        'ai-input', 'ai-chat', 'ai-provider', 'ai-model', 'ai-model-refresh-btn', 'progress-label', 'progress-bar', 'lesson-status',
                        'view-tutorial-btn', 'tutorial-modal', 'tutorial-modal-bg', 'tutorial-modal-content',
                        'tutorial-title', 'tutorial-body', 'close-tutorial-btn', 'editor-placeholder',
                        'editor', 'search-btn', 'format-btn', 'confirm-modal', 'confirm-modal-bg',
                        'confirm-modal-content', 'confirm-modal-title', 'confirm-modal-text',
                        'confirm-modal-cancel-btn', 'confirm-modal-confirm-btn', 'toast-container',
                        'clear-console-btn', 'db-status-light', 'db-status-text', 'reset-progress-btn',
                        'left-panel', 'right-panel', 'resizer', 'lesson-sidebar', 'sidebar-toggle-btn',
                        'lesson-list', 'confetti-canvas', 'solve-btn', 'ai-clear-btn', 'course-select', 'course-title', 'lesson-filter', 'tag-filter', 'lesson-search', 'lesson-tags'
                    ];
                    ids.forEach(id => {
                        const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                        this.elements[camelCaseId] = document.getElementById(id);
                    });
                }

                initEditor() {
                    const amdRequire = (window && window.require) ? window.require : (globalThis && globalThis.require ? globalThis.require : null);
                    if (!amdRequire) {
                        this.showToast('Editor failed to load (require missing)', 'error');
                        return;
                    }
                    amdRequire.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs' }});
                    amdRequire(['vs/editor/editor.main'], () => {
                        monaco.editor.defineTheme('gemini-dark-pro', {
                            base: 'vs-dark',
                            inherit: true,
                            rules: [],
                            colors: { 
                                'editor.background': '#1E1E1E',
                                'editor.lineHighlightBackground': '#2a2a2e'
                            }
                        });

                        // Register hover provider for tooltips
                        monaco.languages.registerHoverProvider('java', {
                            provideHover: (model, position) => {
                                const word = model.getWordAtPosition(position);
                                if (!word) return;
                                const keyword = word.word;
                                const explanations = {
                                    'public': 'An access modifier. `public` members are visible to all other classes.',
                                    'class': 'A blueprint for creating objects. It contains fields (variables) and methods (functions).',
                                    'static': 'A keyword that means the member belongs to the class itself, not to an instance of the class.',
                                    'void': 'A return type that indicates a method does not return any value.',
                                    'main': 'The entry point of a Java application. The code inside the `main` method is executed when the program starts.',
                                    'String': 'A data type that represents a sequence of characters (text).',
                                    'int': 'A primitive data type for storing whole numbers (integers).',
                                    'double': 'A primitive data type for storing floating-point (decimal) numbers.',
                                    'boolean': 'A primitive data type that can only have two values: `true` or `false`.',
                                    'char': 'A primitive data type for storing a single character.',
                                    'if': 'A conditional statement that executes a block of code if a specified condition is true.',
                                    'else': 'Used with `if` to execute a block of code when the condition is false.',
                                    'for': 'A control flow statement for creating a loop that executes a block of code a specific number of times.',
                                    'while': 'Creates a loop that executes a block of code as long as a condition remains true.',
                                    'switch': 'A control flow statement that allows a variable to be tested for equality against a list of values.',
                                    'case': 'A keyword used inside a `switch` statement to define a block of code to be executed.',
                                    'break': 'A keyword used to exit a `switch` statement or a loop.',
                                    'default': 'A keyword for a `switch` statement that specifies the code to run if there is no case match.',
                                    'new': 'An operator used to create new objects.',
                                    'return': 'A keyword to exit a method, with or without a value.',
                                    'import': 'A statement to import classes or entire packages into the current file.',
                                    'Scanner': 'A class in `java.util` used for obtaining the input of the primitive types like int, double, etc. and strings.'
                                };

                                if (explanations[keyword]) {
                                    return {
                                        range: new monaco.Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn),
                                        contents: [
                                            { value: `**\`${keyword}\`**` },
                                            { value: explanations[keyword] }
                                        ]
                                    };
                                }
                            }
                        });

                        this.editor = monaco.editor.create(this.elements.editor, {
                            language: 'java',
                            theme: 'gemini-dark-pro',
                            automaticLayout: true,
                            fontSize: 14, 
                            wordWrap: 'on',
                            folding: true,
                            padding: { top: 18, bottom: 18 },
                            scrollBeyondLastLine: false,
                            renderLineHighlight: 'all',
                            smoothScrolling: true,
                            cursorBlinking: 'smooth',
                            minimap: { enabled: true }
                        });

                        this.editor.onDidChangeModelContent(() => {
                            if (!this.lessons || this.lessons.length === 0) return;
                            const lessonId = this.lessons[this.currentLessonIndex].id;
                            this.userCode[lessonId] = this.editor.getValue();
                            this.saveState(false);
                        });

                        // Ensure editor reflects current lesson/track language immediately after init
                        if (this.lessons && this.lessons.length > 0) {
                            this.loadLesson(this.currentLessonIndex, { isReload: true });
                        }

                        this.editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
                            this.elements.runBtn.click();
                        });

                        this.elements.editorPlaceholder.style.display = 'none';
                        this.elements.editor.style.opacity = '1';
                    });
                }

                addEventListeners() {
                    // Add model change listener
                    if (this.elements.aiModel) {
                        this.elements.aiModel.addEventListener('change', () => {
                            const provider = (this.elements.aiProvider && this.elements.aiProvider.value) || 
                                          localStorage.getItem(`aiProvider-${this.currentTrack}`) || 'ollama';
                            const storageKey = provider === 'lmstudio' 
                                ? `lmstudioModel-${this.currentTrack}` 
                                : `ollamaModel-${this.currentTrack}`;
                            localStorage.setItem(storageKey, this.elements.aiModel.value);
                        });
                    }
                    
                    this.elements.runBtn.addEventListener('click', () => this.runCodeCheck());
                    this.elements.solveBtn.addEventListener('click', () => {
                        this.showConfirmation(
                            'Load Solution?',
                            'This will replace your current code in the editor with the official solution for this lesson. Your changes will be lost.',
                            () => this.solveLesson(),
                            'btn-warning'
                        );
                    });
                    this.elements.resetBtn.addEventListener('click', () => {
                        this.showConfirmation(
                            'Reset Code?',
                            'This will discard your current code for this lesson and restore the original template. This cannot be undone.',
                            () => this.resetCode()
                        );
                    });
                     this.elements.resetProgressBtn.addEventListener('click', () => {
                        this.showConfirmation(
                            'Reset All Progress?',
                            'This will permanently delete all your saved code and completion history from your browser\'s local storage. Are you absolutely sure?',
                            () => this.storageService.resetProgress(),
                            'btn-danger'
                        );
                    });
                    this.elements.prevLessonBtn.addEventListener('click', () => this.loadLesson(this.currentLessonIndex - 1));
                    this.elements.nextLessonBtn.addEventListener('click', () => this.loadLesson(this.currentLessonIndex + 1));
                    this.elements.aiAskBtn.addEventListener('click', () => this.handleAIChat());
                    this.elements.aiInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.handleAIChat(); } });
                    this.elements.aiInput.addEventListener('input', e => {
                        e.target.style.height = 'auto';
                        e.target.style.height = (e.target.scrollHeight) + 'px';
                    });

                    // Quick action buttons
                    const hintBtn = document.getElementById('hint-btn');
                    const explainBtn = document.getElementById('explain-btn');
                    const debugBtn = document.getElementById('debug-btn');
                    const bestPracticesBtn = document.getElementById('best-practices-btn');

                    if (hintBtn) hintBtn.addEventListener('click', () => this.askQuickQuestion('Give me a hint for this lesson'));
                    if (explainBtn) explainBtn.addEventListener('click', () => this.askQuickQuestion('Explain the concept in this lesson'));
                    if (debugBtn) debugBtn.addEventListener('click', () => this.askQuickQuestion('Help me debug my code'));
                    if (bestPracticesBtn) bestPracticesBtn.addEventListener('click', () => this.askQuickQuestion('Show me best practices for this'));
                    this.elements.viewTutorialBtn.addEventListener('click', () => this.openTutorial());
                    this.elements.closeTutorialBtn.addEventListener('click', () => this.closeModal('tutorial'));
                    this.elements.tutorialModalBg.addEventListener('click', () => this.closeModal('tutorial'));
                    
                    this.elements.confirmModalCancelBtn.addEventListener('click', () => this.closeModal('confirm'));
                    this.elements.confirmModalBg.addEventListener('click', () => this.closeModal('confirm'));

                    this.elements.searchBtn.addEventListener('click', () => this.editor.getAction('actions.find').run());
                    this.elements.formatBtn.addEventListener('click', () => this.editor.getAction('editor.action.formatDocument').run());
                    this.elements.clearConsoleBtn.addEventListener('click', () => this.clearConsole(true));
                    this.elements.sidebarToggleBtn.addEventListener('click', () => this.toggleSidebar());
                    if (this.elements.aiClearBtn) {
                        this.elements.aiClearBtn.addEventListener('click', () => this.clearChat());
                    }
                    if (this.elements.aiModelRefreshBtn) {
                        this.elements.aiModelRefreshBtn.addEventListener('click', () => this.initOllamaModels(true));
                    }

                    if (this.elements.lessonFilter) {
                        this.elements.lessonFilter.addEventListener('change', () => {
                            this.lessonFilter = this.elements.lessonFilter.value || 'all';
                            try { localStorage.setItem(`lessonFilter-${this.currentTrack}`, this.lessonFilter); } catch (_) {}
                            this.populateLessonSidebarDebounced();
                        });
                    }
                    if (this.elements.lessonSearch) {
                        this.elements.lessonSearch.addEventListener('input', () => {
                            this.lessonSearchQuery = String(this.elements.lessonSearch.value || '').trim();
                            try { localStorage.setItem(`lessonSearch-${this.currentTrack}`, this.lessonSearchQuery); } catch (_) {}
                            this.populateLessonSidebarDebounced();
                        });
                    }
                    if (this.elements.tagFilter) {
                        this.elements.tagFilter.addEventListener('change', () => {
                            this.tagFilter = this.elements.tagFilter.value || 'all';
                            try { localStorage.setItem(`tagFilter-${this.currentTrack}`, this.tagFilter); } catch (_) {}
                            this.populateLessonSidebarDebounced();
                        });
                    }
                }

                initProviderSelect() {
                    const select = this.elements.aiProvider;
                    if (!select) return;
                    const providers = [
                        { value: 'ollama', label: 'Ollama' },
                        { value: 'lmstudio', label: 'LM Studio' },
                    ];
                    select.innerHTML = '';
                    providers.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.value;
                        opt.textContent = p.label;
                        select.appendChild(opt);
                    });
                    const providerKey = `aiProvider-${this.currentTrack}`;
                    const savedProvider = localStorage.getItem(providerKey) || 'ollama';
                    select.value = providers.some(p => p.value === savedProvider) ? savedProvider : 'ollama';
                    select.addEventListener('change', () => {
                        localStorage.setItem(providerKey, select.value);
                        this.initOllamaModels(true);
                    });
                }

                addResizerLogic() {
                    const resizer = this.elements.resizer;
                    const leftPanel = this.elements.leftPanel;
                    const rightPanel = this.elements.rightPanel;

                    const mouseMoveHandler = (e) => {
                        const sidebarWidth = this.elements.lessonSidebar.offsetWidth;
                        const totalWidth = leftPanel.parentElement.offsetWidth;
                        let newLeftWidth = ((e.clientX - sidebarWidth) / totalWidth) * 100;
                        
                        // Enforce min/max width constraints
                        newLeftWidth = Math.max(20, Math.min(80, newLeftWidth));

                        leftPanel.style.width = `${newLeftWidth}%`;
                        rightPanel.style.width = `${100 - newLeftWidth}%`;
                    };

                    const mouseUpHandler = () => {
                        resizer.classList.remove('resizing');
                        window.removeEventListener('mousemove', mouseMoveHandler);
                        window.removeEventListener('mouseup', mouseUpHandler);
                    };

                    resizer.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        resizer.classList.add('resizing');
                        window.addEventListener('mousemove', mouseMoveHandler);
                        window.addEventListener('mouseup', mouseUpHandler);
                    });
                }

                // Utility: simple debounce bound to this instance
                debounce(fn, wait = 150) {
                    let t = null;
                    return (...args) => {
                        if (t) clearTimeout(t);
                        t = setTimeout(() => fn.apply(this, args), wait);
                    };
                }

                resetUI() {
                    this.clearConsole(true);
                    const welcomeMessage = [
                        "I'm your AI assistant. Stuck? Try the tutorial first, then ask me for a hint!",
                        "\n\n",
                        "Tip: For blazing-fast local responses, try ",
                        "**NVIDIA-Nemotron-Nano-12B-v2-GGUF**.",
                        " If Ollama doesnt have it, you can load it via ",
                        "[LM Studio](https://lmstudio.ai)."
                    ].join("");
                    const html = this.renderMarkdown(welcomeMessage);
                    this.elements.aiChat.innerHTML = `<div class="chat-bubble markdown-body p-3 rounded-lg bg-gemini-bg-tertiary self-start mr-auto">${html}</div>`;
                    this.populateLessonSidebar();
                }

                async initOllamaModels(showToastOnError = false) {
                    const modelSelect = this.elements.aiModel;
                    if (!modelSelect) return;
                    const provider = (this.elements.aiProvider && this.elements.aiProvider.value) || localStorage.getItem(`aiProvider-${this.currentTrack}`) || 'ollama';
                    const endpoint = provider === 'lmstudio' ? '/lmstudio/models' : '/ollama/models';
                    const storageKey = provider === 'lmstudio' ? `lmstudioModel-${this.currentTrack}` : `ollamaModel-${this.currentTrack}`;
                    try {
                        modelSelect.innerHTML = '';
                        const resp = await fetch(endpoint);
                        if (!resp.ok) throw new Error(`Failed to fetch models: ${resp.status}`);
                        const data = await resp.json();
                        const models = data.models || [];
                        if (models.length === 0) {
                            const opt = document.createElement('option');
                            opt.value = '';
                            opt.textContent = 'No models found';
                            modelSelect.appendChild(opt);
                            if (showToastOnError) {
                                if (provider === 'lmstudio') {
                                    this.showToast('No LM Studio models found. Start LM Studio server (http://127.0.0.1:1234) and load a model.', 'error');
                                } else {
                                    this.showToast('No Ollama models found. Start Ollama and pull a model (e.g., "ollama pull llama3.1").', 'error');
                                }
                            }
                            return;
                        }
                        const saved = localStorage.getItem(storageKey);
                        models.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.name;
                            opt.textContent = m.name;
                            modelSelect.appendChild(opt);
                        });
                        if (saved && models.some(m => m.name === saved)) {
                            modelSelect.value = saved;
                        } else {
                            modelSelect.value = models[0].name;
                            localStorage.setItem(storageKey, modelSelect.value);
                        }
                        // Event listener moved to addEventListeners
                    } catch (err) {
                        const opt = document.createElement('option');
                        opt.value = '';
                        opt.textContent = 'Models unavailable';
                        modelSelect.appendChild(opt);
                        if (showToastOnError) {
                            if (provider === 'lmstudio') {
                                this.showToast('Unable to reach LM Studio. Is it running on http://127.0.0.1:1234?', 'error');
                            } else {
                                this.showToast('Unable to reach Ollama. Is it running on port 11434?', 'error');
                            }
                        }
                    }
                }

                async loadLesson(index, options = {}) {
                    if (index < 0 || index >= this.lessons.length || !this.isDbReady) return;
                    // Ensure full lesson details are loaded before rendering
                    try {
                        const maybe = this.lessons[index] || {};
                        const hasDetails = !!(maybe && typeof maybe === 'object' && maybe.initialCode && (('expectedOutput' in maybe) || maybe.expectedOutput === '') && maybe.tutorial);
                        if (!hasDetails) {
                            await this.ensureLessonDetails(index);
                        }
                    } catch (_) {}
                    
                    const lessonPanel = document.getElementById('lesson-panel');
                    lessonPanel.classList.remove('fade-in');
                    lessonPanel.style.opacity = '0';
                    
                    this.currentLessonIndex = index;
                    this.saveState(true); 
                    const lesson = this.lessons[this.currentLessonIndex];
                    const isCompleted = this.lessonCompletion[lesson.id];

                    this.elements.nextLessonBtn.classList.remove('animate-pulse', 'bg-emerald-500');
                    this.elements.nextLessonBtn.querySelector('span').textContent = 'Next';

                    setTimeout(() => {
                        // Remove number prefix from title if it exists (e.g., "431. Parsing XML" -> "Parsing XML")
                        const cleanTitle = lesson.title.replace(/^\d+\.\s*/, '');
                        this.elements.lessonTitle.innerHTML = `<div class="text-center w-full"><span class="text-purple-400 text-lg font-semibold">Lesson ${lesson.id}</span></div><div class="mt-2">${cleanTitle} ${isCompleted ? '<i class="fa-solid fa-circle-check text-emerald-400 ml-3 text-xl"></i>' : ''}</div>`;
                        this.elements.lessonDescription.textContent = lesson.description;
                        // Render derived tags
                        try {
                            const tags = this.deriveTagsForLesson(lesson);
                            const chips = (tags || []).map(t => `<span class="px-2 py-0.5 text-xs rounded-full bg-[#3c4043] text-gray-200 border border-[#4b5257]">${t}</span>`).join('');
                            if (this.elements.lessonTags) this.elements.lessonTags.innerHTML = chips;
                        } catch (_) { if (this.elements.lessonTags) this.elements.lessonTags.innerHTML = ''; }
                        
                        this.updateLessonStatus(lesson.id);
                        this.populateLessonSidebar();

                        if (this.editor) {
                            try {
                                const lang = (lesson.language ? String(lesson.language) : (this.currentTrack || 'java')).toLowerCase();
                                const monacoLang = (lang === 'python') ? 'python' : 'java';
                                monaco.editor.setModelLanguage(this.editor.getModel(), monacoLang);
                            } catch (_) {}
                            const savedCode = this.userCode[lesson.id];
                            this.editor.setValue(savedCode || lesson.initialCode);
                            this.editor.focus();
                        }
                        if (!options.isReload) {
                            this.logToConsole(`Lesson "${lesson.title}" loaded.`);
                        }
                        this.elements.prevLessonBtn.disabled = this.currentLessonIndex === 0;
                        this.elements.nextLessonBtn.disabled = this.currentLessonIndex === this.lessons.length - 1;
                        
                        this.updateProgress();

                        this.elements.viewTutorialBtn.style.display = lesson.tutorial ? 'flex' : 'none';
                        
                        lessonPanel.style.opacity = '1';
                        lessonPanel.classList.add('fade-in');
                    }, 200);
                }

                async ensureLessonDetails(index) {
                    try {
                        const summary = this.lessons[index];
                        if (!summary || typeof summary !== 'object') return;
                        const hasDetails = !!(summary.initialCode && (('expectedOutput' in summary) || summary.expectedOutput === '') && summary.tutorial);
                        if (hasDetails) return;
                        const lang = (summary.language ? String(summary.language) : (this.currentTrack || 'java')).toLowerCase() === 'python' ? 'python' : 'java';
                        const url = `/api/lessons/${lang}/${summary.id}`;
                        const r = await fetch(url, { cache: 'no-cache' });
                        if (!r.ok) return;
                        const d = await r.json();
                        if (d && d.item) {
                            this.lessons[index] = { ...summary, ...d.item };
                        }
                    } catch (_) { /* ignore */ }
                }

                resetCode() {
                    const lesson = this.lessons[this.currentLessonIndex];
                    this.editor.setValue(lesson.initialCode);
                    this.logToConsole('Code has been reset to the initial state.', 'info');
                }
                
                solveLesson() {
                    const lesson = this.lessons[this.currentLessonIndex];
                    if (!lesson) return;
                    const lang = (lesson.language ? String(lesson.language) : (this.currentTrack || 'java')).toLowerCase();
                    if (lesson.fullSolution) {
                        let code = lesson.fullSolution;
                        let usedCommented = false;
                        if (lang === 'python') {
                            const commented = lesson.fullSolutionCommented && String(lesson.fullSolutionCommented).trim().length > 0
                                ? lesson.fullSolutionCommented
                                : this.generateCommentedPythonSolution(code, lesson);
                            if (commented && commented !== code) { usedCommented = true; }
                            code = commented || code;
                        } else {
                            const commented = lesson.fullSolutionCommented && String(lesson.fullSolutionCommented).trim().length > 0
                                ? lesson.fullSolutionCommented
                                : this.generateCommentedJavaSolution(code, lesson);
                            if (commented && commented !== code) { usedCommented = true; }
                            code = commented || code;
                        }
                        this.editor.setValue(code);
                        this.logToConsole(`Lesson solution loaded${usedCommented ? ' (commented)' : ''} into the editor.`, 'info');
                    } else {
                        this.showToast("No solution available for this lesson.", "error");
                    }
                }

                generateCommentedPythonSolution(code, lesson) {
                    try {
                        const lines = String(code || '').split(/\r?\n/);
                        const out = [];
                        out.push('# --- Solution (with comments) ---');
                        if (lesson && lesson.title) out.push(`# ${lesson.title}`);
                        if (lesson && lesson.description) out.push(`# ${String(lesson.description).replace(/\n/g, ' ')}`);
                        for (const ln of lines) {
                            const trimmed = ln.trim();
                            const indent = ln.match(/^\s*/)[0];
                            if (!trimmed) { out.push(ln); continue; }
                            let cmt = null;
                            if (/^print\s*\(/.test(trimmed)) cmt = 'Print output to the console';
                            else if (/^for\s+/.test(trimmed)) cmt = 'For loop iteration';
                            else if (/^while\s+/.test(trimmed)) cmt = 'While loop';
                            else if (/^def\s+/.test(trimmed)) cmt = 'Function definition';
                            else if (/^class\s+/.test(trimmed)) cmt = 'Class definition';
                            else if (/^\w+\s*\+=\s*1\b/.test(trimmed)) {
                                const varname = trimmed.split('+=')[0].trim();
                                cmt = `Increment ${varname}`;
                            } else if (/^\w+\s*=\s*.+/.test(trimmed)) {
                                const varname = trimmed.split('=')[0].trim();
                                cmt = `Assign value to ${varname}`;
                            }
                            if (cmt) out.push(`${indent}# ${cmt}`);
                            out.push(ln);
                        }
                        return out.join('\n');
                    } catch (_) {
                        return code;
                    }
                }

                generateCommentedJavaSolution(code, lesson) {
                    try {
                        const lines = String(code || '').split(/\r?\n/);
                        const out = [];
                        out.push('// --- Solution (with comments) ---');
                        if (lesson && lesson.title) out.push(`// ${lesson.title}`);
                        if (lesson && lesson.description) out.push(`// ${String(lesson.description).replace(/\n/g, ' ')}`);
                        for (const ln of lines) {
                            const trimmed = ln.trim();
                            const indentMatch = ln.match(/^\s*/);
                            const indent = indentMatch ? indentMatch[0] : '';
                            if (!trimmed) { out.push(ln); continue; }
                            // Skip existing comment or block-comment lines
                            if (trimmed.startsWith('//') || trimmed.startsWith('/*') || trimmed.startsWith('*')) { out.push(ln); continue; }
                            let cmt = null;
                            if (/^System\.out\.println?\s*\(/.test(trimmed)) cmt = 'Print output to the console';
                            else if (/^for\s*\(/.test(trimmed)) cmt = 'For loop iteration';
                            else if (/^while\s*\(/.test(trimmed)) cmt = 'While loop';
                            else if (/^if\s*\(/.test(trimmed)) cmt = 'If condition';
                            else if (/^else\s+if\s*\(/.test(trimmed)) cmt = 'Else-if condition';
                            else if (/^else\b/.test(trimmed)) cmt = 'Else branch';
                            else if (/^(public|private|protected)?\s*static\s+void\s+main\s*\(/.test(trimmed)) cmt = 'Program entry point (main method)';
                            else if (/^class\s+\w+/.test(trimmed)) cmt = 'Class definition';
                            else if (/^(public|private|protected)?\s*(static\s+)?[A-Za-z_][\w<>\[\]]*\s+[A-Za-z_][\w]*\s*\(.*\)\s*\{?\s*$/.test(trimmed)) cmt = 'Method definition';
                            else if (/\w+\s*\+\+/.test(trimmed) || /\+\+\w+/.test(trimmed)) {
                                const m = trimmed.match(/(\w+)\s*\+\+|\+\+(\w+)/);
                                const varname = m ? (m[1] || m[2]) : null;
                                cmt = varname ? `Increment ${varname}` : 'Increment variable';
                            } else if (/^\w+\s*\+=\s*1\b/.test(trimmed)) {
                                const varname = trimmed.split('+=')[0].trim();
                                cmt = `Increment ${varname}`;
                            } else if (/^(final\s+)?[A-Za-z_][\w<>\[\]]*\s+[A-Za-z_][\w]*\s*=/.test(trimmed)) {
                                const m = trimmed.match(/^(?:final\s+)?[A-Za-z_][\w<>\[\]]*\s+([A-Za-z_][\w]*)\s*=/);
                                const varname = m ? m[1] : null;
                                cmt = varname ? `Declare and initialize ${varname}` : 'Declare and initialize variable';
                            } else if (/^return\b/.test(trimmed)) cmt = 'Return from method';
                            else if (/\.add\s*\(/.test(trimmed)) cmt = 'Add element to collection';
                            else if (/\.put\s*\(/.test(trimmed)) cmt = 'Insert entry into map';
                            if (cmt) out.push(`${indent}// ${cmt}`);
                            out.push(ln);
                        }
                        return out.join('\n');
                    } catch (_) {
                        return code;
                    }
                }

                // =================================================================
                // === REAL CODE EXECUTION VIA BACKEND SERVER ======================
                // =================================================================
                async runCodeCheck() {
                    if (!this.editor) return;

                    const userCode = this.editor.getValue();
                    const currentLesson = this.lessons[this.currentLessonIndex];

                    this.clearConsole();
                    this.logToConsole('Executing code on server...', 'info');

                    try {
                        // Prepare payload with code and optional user input
                        const payload = { code: userCode };
                        // Use the currentLesson reference to include simulated input
                        if (currentLesson && currentLesson.userInput && currentLesson.userInput.length > 0) {
                            payload.input = currentLesson.userInput.join('\n');
                        }
                        
                        // Pick backend endpoint by language (fallback to current course track)
                        const lang = (currentLesson && currentLesson.language)
                            ? String(currentLesson.language).toLowerCase()
                            : ((this.currentTrack || 'java'));
                        const runEndpoint = (lang === 'python') ? '/run/python' : '/run/java';
                        // Send code to the backend server
                        const response = await fetch(runEndpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        const actualOutput = result.output || "";
                        
                        this.logToConsole('Execution finished.', 'info');

                        if (result.error) {
                            const errorType = result.type === 'compilation' ? 'Compilation Error' : 'Runtime Error';
                            this.logToConsole(` ${errorType}:`, 'error');
                            // Clean up the error message for better readability
                            const cleanedError = actualOutput.replace(/Main.java:\d+:/g, 'Line: ');
                            this.logToConsole(cleanedError, 'error');
                            this.updateLessonStatus(currentLesson.id);
                            return;
                        }
                        
                        // Log the actual output from the server
                        this.logToConsole(actualOutput, 'user-output');

                        // --- Compare server output with expected output ---
                        const normalize = (str) => (str || '').trim().replace(/\r\n/g, '\n');
                        let expectedOutput = currentLesson.expectedOutput;
                        let isCorrect = false;

                        // Special check for Lesson 9 (dynamic output)
                        if ((currentLesson.id === 9) && (lang !== 'python')) { 
                            const methodCallMatch = userCode.match(/greetUser\s*\(\s*"([^"]+)"\s*\)/);
                            if (methodCallMatch && methodCallMatch[1]) {
                                expectedOutput = `Hello, ${methodCallMatch[1]}!`;
                                if (normalize(actualOutput) === normalize(expectedOutput)) {
                                    isCorrect = true;
                                }
                            } else {
                                this.logToConsole(` Not quite right. Could not find a valid call to the greetUser method with a name in double quotes, like greetUser("Alex");`, 'error');
                                return;
                            }
                        // Special check for Lesson 44 (HashMap order is not guaranteed)
                        } else if ((currentLesson.id === 44) && (lang !== 'python')) { 
                            const expectedLines = normalize(expectedOutput).split('\n').sort();
                            const actualLines = normalize(actualOutput).split('\n').sort();
                            if (JSON.stringify(expectedLines) === JSON.stringify(actualLines)) {
                                isCorrect = true;
                            }
                        } else {
                            // Standard check for all other lessons
                            if (normalize(actualOutput) === normalize(expectedOutput)) {
                                isCorrect = true;
                            }
                        }

                        if (isCorrect) {
                            this.logToConsole(` Success! You completed "${currentLesson.title}".`, 'success');
                            this.triggerConfetti();
                            this.lessonCompletion[currentLesson.id] = true;
                            this.saveState(true);
                            this.loadLesson(this.currentLessonIndex, { isReload: true });
                            this.populateLessonSidebar();

                            if (this.currentLessonIndex < this.lessons.length - 1) {
                                this.elements.nextLessonBtn.classList.add('animate-pulse', 'bg-emerald-500');
                                this.elements.nextLessonBtn.querySelector('span').textContent = 'Continue';
                            }
                        } else {
                            this.logToConsole(` Not quite right. The code runs, but the output doesn't match.`, 'error');
                            if (expectedOutput) {
                                this.logToConsole('Expected output:', 'info');
                                this.logToConsole(expectedOutput, 'system-output');
                            }
                            this.logToConsole('Your output:', 'info');
                            this.logToConsole(actualOutput || '(No output)', 'user-output');
                            this.updateLessonStatus(currentLesson.id);
                        }

                    } catch (error) {
                        console.error('Network or server error:', error);
                        this.logToConsole(' Error connecting to the execution server. Is it running?', 'error');
                        this.logToConsole(error.message, 'error');
                    }
                }
                
                // =================================================================
                // === UI AND STATE MANAGEMENT METHODS (Unchanged) =================
                // =================================================================
                
                updateLessonStatus(lessonId) {
                    if (this.lessonCompletion[lessonId]) {
                        this.elements.lessonStatus.innerHTML = '<i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>Completed!';
                    } else {
                        this.elements.lessonStatus.innerHTML = '';
                    }
                }
                
                updateProgress() {
                    const completedCount = Object.values(this.lessonCompletion).filter(Boolean).length;
                    const progress = (completedCount / this.lessons.length) * 100;
                    this.elements.progressBar.style.width = `${progress}%`;
                    this.elements.progressLabel.textContent = `Completed: ${completedCount}/${this.lessons.length} lessons`;
                }

                toggleSidebar() {
                    this.elements.lessonSidebar.classList.toggle('hidden');
                }                stripHtml(s) {
                    try { return String(s || '').replace(/<[^>]*>/g, ' '); } catch (_) { return String(s || ''); }
                }

                deriveTagsForLesson(lesson) {
                    try {
                        const tags = new Set();
                        if (Array.isArray(lesson.tags)) {
                            for (const t of lesson.tags) if (t && String(t).trim()) tags.add(String(t).trim());
                        }
                        const hay = [lesson.title, lesson.description, this.stripHtml(lesson.tutorial)]
                            .filter(Boolean).join(' ').toLowerCase();
                        const has = (...xs) => xs.some(x => hay.includes(x));
                        // General domains
                        if (has('stream', 'collectors', 'flatmap', 'map(', 'reduce', 'groupingby')) tags.add('Streams');
                        if (has('file', 'path', 'nio', 'io.', 'read', 'write', 'open(', 'pathlib', 'with open')) tags.add('I/O');
                        if (has('thread', 'executor', 'future', 'completablefuture', 'concurrent', 'lock', 'synchronized', 'asyncio', 'await', 'threadpoolexecutor')) tags.add('Concurrency');
                        if (has('class', 'interface', 'inheritance', 'polymorph', 'dataclass')) tags.add('OOP');
                        if (has('map<', 'hashmap', 'linkedhashset', 'set<', 'list<', 'collections', 'itertools')) tags.add('Collections');
                        if (has('regex', 'pattern', 'matcher', 're.')) tags.add('Regex');
                        if (has('optional', 'option', 'nullable')) tags.add('Optional');
                        if (has('localdate', 'datetime')) tags.add('Date/Time');
                        return Array.from(tags);
                    } catch (_) { return []; }
                }

                collectAvailableTags() {
                    const set = new Set();
                    (this.lessons || []).forEach(l => {
                        for (const t of this.deriveTagsForLesson(l)) set.add(t);
                    });
                    return Array.from(set).sort((a,b)=>a.localeCompare(b));
                }

                refreshTagFilterOptions() {
                    const sel = this.elements.tagFilter;
                    if (!sel) return;
                    const cur = this.tagFilter || 'all';
                    const tags = this.collectAvailableTags();
                    sel.innerHTML = '';
                    const def = document.createElement('option');
                    def.value = 'all'; def.textContent = 'All Tags';
                    sel.appendChild(def);
                    tags.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t; opt.textContent = t;
                        sel.appendChild(opt);
                    });
                    sel.value = tags.includes(cur) || cur === 'all' ? cur : 'all';
                }

                initTagFilter() {
                    const sel = this.elements.tagFilter;
                    if (!sel) return;
                    const key = `tagFilter-${this.currentTrack}`;
                    const saved = localStorage.getItem(key) || this.tagFilter || 'all';
                    this.tagFilter = saved;
                    sel.value = saved;
                }

                populateLessonSidebar() {
                    const list = this.elements.lessonList;
                    list.innerHTML = '';
                    let view = this.lessons || [];

                    // Level filter - updated for 700 lessons with bridging lessons
                    if (this.lessonFilter === 'beginner') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 1 && l.id <= 104) : true);
                    } else if (this.lessonFilter === 'intermediate') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 105 && l.id <= 214) : false);
                    } else if (this.lessonFilter === 'advanced') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 215 && l.id <= 374) : false);
                    } else if (this.lessonFilter === 'expert') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 375 && l.id <= 532) : false);
                    } else if (this.lessonFilter === 'enterprise') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 533 && l.id <= 639) : false);
                    } else if (this.lessonFilter === 'faang') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 640 && l.id <= 689) : false);
                    } else if (this.lessonFilter === 'jobready') {
                        view = view.filter(l => (typeof l.id === 'number') ? (l.id >= 690 && l.id <= 700) : false);
                    }

                    // Tag filter
                    const selectedTag = this.tagFilter || 'all';
                    if (selectedTag && selectedTag !== 'all') {
                        view = view.filter(l => this.deriveTagsForLesson(l).includes(selectedTag));
                    }

                    // Search filter - supports title, description, or lesson number (#123)
                    const q = String(this.lessonSearchQuery || '').toLowerCase().trim();
                    if (q) {
                        view = view.filter(l => {
                            try {
                                // Check if searching by lesson number (#123 or just 123)
                                const numMatch = q.match(/^#?(\d+)$/);
                                if (numMatch) {
                                    const searchNum = parseInt(numMatch[1], 10);
                                    return l.id === searchNum;
                                }
                                // Otherwise search in title and description
                                const hay = `${l.title || ''} ${l.description || ''}`.toLowerCase();
                                return hay.includes(q);
                            } catch (_) { return true; }
                        });
                    }
                    view.forEach((lesson) => {
                        const index = this.lessons.findIndex(x => x.id === lesson.id);
                        const isCompleted = this.lessonCompletion[lesson.id];
                        const isActive = index === this.currentLessonIndex;
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = `sidebar-lesson-item flex items-center justify-between p-3 rounded-md text-sm transition-colors hover:bg-gemini-bg-tertiary ${isActive ? 'active' : ''}`;
                        item.innerHTML = `
                            <span class="truncate"><span class="text-gray-400 mr-2">${lesson.id}.</span>${lesson.title}</span>
                            ${isCompleted ? '<i class="fa-solid fa-circle-check text-emerald-400 ml-2 flex-shrink-0"></i>' : ''}
                        `;
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.loadLesson(index);
                        });
                        list.appendChild(item);
                    });
                }

                initLessonFilter() {
                    const sel = this.elements.lessonFilter;
                    if (!sel) return;
                    const key = `lessonFilter-${this.currentTrack}`;
                    const saved = localStorage.getItem(key) || this.lessonFilter || 'all';
                    const validFilters = ['all', 'beginner', 'intermediate', 'advanced', 'expert', 'enterprise', 'faang', 'jobready'];
                    sel.value = validFilters.includes(saved) ? saved : 'all';
                    this.lessonFilter = sel.value;
                }
                
                initLessonSearch() {
                    const inp = this.elements.lessonSearch;
                    if (!inp) return;
                    const key = `lessonSearch-${this.currentTrack}`;
                    const saved = localStorage.getItem(key) || this.lessonSearchQuery || '';
                    this.lessonSearchQuery = saved;
                    inp.value = saved;
                }
                
                showConfirmation(title, text, onConfirm, confirmClass = 'btn-danger') {
                    this.elements.confirmModalTitle.textContent = title;
                    this.elements.confirmModalText.textContent = text;
                    
                    const confirmBtn = this.elements.confirmModalConfirmBtn;
                    confirmBtn.className = `btn ${confirmClass}`;
                    
                    confirmBtn.onclick = () => {
                        onConfirm();
                        this.closeModal('confirm');
                    };
                    this.openModal('confirm');
                }

                openModal(type) {
                    const modal = this.elements[`${type}Modal`];
                    const bg = this.elements[`${type}ModalBg`];
                    const content = this.elements[`${type}ModalContent`];

                    modal.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        bg.classList.remove('opacity-0');
                        content.classList.remove('opacity-0', 'scale-95');
                    });
                }

                closeModal(type) {
                    const modal = this.elements[`${type}Modal`];
                    const bg = this.elements[`${type}ModalBg`];
                    const content = this.elements[`${type}ModalContent`];

                    bg.classList.add('opacity-0');
                    content.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => { modal.classList.add('hidden'); }, 300);
                }

                openTutorial() {
                    const lesson = this.lessons[this.currentLessonIndex];
                    if (!lesson.tutorial) return;

                    this.elements.tutorialTitle.innerHTML = `<i class="fa-solid fa-book-open text-sky-400 mr-3"></i> Tutorial: ${lesson.title}`;

                    // Process tutorial content to highlight backtick keywords
                    let tutorialHTML = lesson.tutorial;
                    // Convert backticks to code tags if not already in HTML
                    tutorialHTML = tutorialHTML.replace(/`([^`]+)`/g, '<code class="tutorial-keyword">$1</code>');

                    this.elements.tutorialBody.innerHTML = tutorialHTML;
                    
                    this.elements.tutorialBody.querySelectorAll('.code-block-wrapper').forEach(wrapper => {
                        const pre = wrapper.querySelector('pre');
                        if (!pre) return;
                        const code = pre.textContent.trim();
                        const lineCount = code.split('\n').length;
                        
                        const editorDiv = document.createElement('div');
                        editorDiv.style.height = `${Math.max(lineCount * 21, 50)}px`;
                        wrapper.appendChild(editorDiv);
                        
                        const tutorialLang = (lesson.language ? String(lesson.language) : (this.currentTrack || 'java')).toLowerCase() === 'python' ? 'python' : 'java';
                        monaco.editor.create(editorDiv, {
                            value: code, language: tutorialLang, theme: 'gemini-dark-pro',
                            readOnly: true, domReadOnly: true, automaticLayout: true,
                            minimap: { enabled: false }, lineNumbers: 'off', folding: false,
                            scrollBeyondLastLine: false, contextmenu: false, wordWrap: 'on',
                            padding: { top: 10, bottom: 10 }
                        });
                        this.addCopyToCodeBlock(wrapper, code);
                        pre.remove();
                    });

                    this.openModal('tutorial');
                }

                async loadLessonsForTrack(track) {
                    try {
                        // Reset lessons first to avoid cross-course mixing
                        this.lessons = [];
                        console.log(`[loadLessonsForTrack] Loading ${track} lessons...`);

                        // Try scalable API first (returns summary list); fall back to JSON files if unavailable
                        try {
                            const lang = (track === 'python') ? 'python' : 'java';
                            const apiUrl = `/api/lessons?lang=${lang}&limit=5000&fields=summary`;
                            const resp = await fetch(apiUrl, { cache: 'no-cache' });
                            if (resp.ok) {
                                const data = await resp.json();
                                if (data && Array.isArray(data.items)) {
                                    this.lessons = data.items.filter(l => !l.language || String(l.language).toLowerCase() === lang);
                                    // de-dupe
                                    const seen = new Set();
                                    this.lessons = (this.lessons || []).filter(l => {
                                        const llang = (l.language ? String(l.language) : lang).toLowerCase();
                                        const key = `${llang}:${l.id}`;
                                        if (seen.has(key)) return false;
                                        seen.add(key);
                                        return true;
                                    });
                                    console.log(`[loadLessonsForTrack] Loaded ${this.lessons.length} ${track} lessons via API`);
                                    // lessons loaded via API; UI refresh handled in finally
                                    return; // success via API; skip JSON fallback
                                }
                            }
                        } catch (_) { /* ignore and fall back */ }
                        console.log(`[loadLessonsForTrack] API not available, falling back to JSON file`);


                        if (track === 'python') {
                            // Python lessons are expected in a separate JSON
                            const resp = await fetch('/lessons-python.json', { cache: 'no-cache' });
                            if (!resp.ok) {
                                console.error('[loadLessonsForTrack] Failed to fetch lessons-python.json');
                                this.showToast('Python lessons not found (lessons-python.json)', 'error');
                                this.lessons = [];
                            } else {
                                const data = await resp.json();
                                console.log('[loadLessonsForTrack] Python JSON loaded, data type:', Array.isArray(data) ? 'array' : 'object');
                                const list = Array.isArray(data) ? data : (Array.isArray(data.lessons) ? data.lessons : []);
                                console.log('[loadLessonsForTrack] Python raw lessons count:', list.length);
                                this.lessons = (list || []).filter(l => !l.language || String(l.language).toLowerCase() === 'python');
                                console.log('[loadLessonsForTrack] Python filtered lessons count:', this.lessons.length);
                                console.log('[loadLessonsForTrack] Sample Python lesson:', this.lessons[0]?.id, this.lessons[0]?.title, this.lessons[0]?.language);
                                const issues = this.validateLessonsList(this.lessons, 'python');
                                if (issues.length > 0) {
                                    console.warn('[lessons] validation issues (python):', issues);
                                }
                            }
                        } else if (track === 'java') {
                            // Java lessons are sourced from public/lessons-java.json
                            try {
                                const r = await fetch('/lessons-java.json', { cache: 'no-cache' });
                                if (!r.ok) {
                                    console.error('[loadLessonsForTrack] Failed to fetch lessons-java.json');
                                    this.showToast('Java lessons not found (lessons-java.json)', 'error');
                                    // Fallback to any built-in copy if present
                                    this.lessons = [];
                                } else {
                                    const d = await r.json();
                                    console.log('[loadLessonsForTrack] Java JSON loaded, data type:', Array.isArray(d) ? 'array' : 'object');
                                    const m = Array.isArray(d) ? 'replace' : (d.mode === 'replace' ? 'replace' : 'append');
                                    const incomingAll = Array.isArray(d) ? d : (Array.isArray(d.lessons) ? d.lessons : []);
                                    console.log('[loadLessonsForTrack] Java raw lessons count:', incomingAll.length);
                                    const incoming = (incomingAll || []).filter(l => !l.language || String(l.language).toLowerCase() === 'java');
                                    console.log('[loadLessonsForTrack] Java filtered lessons count:', incoming.length);
                                    if (m === 'replace') {
                                        this.lessons = incoming;
                                    } else {
                                        // Append to any built-in copy if non-empty
                                        this.lessons = [...(this.lessons || []), ...incoming];
                                    }
                                    console.log('[loadLessonsForTrack] Java final lessons count:', this.lessons.length);
                                    console.log('[loadLessonsForTrack] Sample Java lesson:', this.lessons[0]?.id, this.lessons[0]?.title, this.lessons[0]?.language);
                                    const issues = this.validateLessonsList(this.lessons, 'java');
                                    if (issues.length > 0) {
                                        console.warn('[lessons] validation issues (java):', issues);
                                    }
                                }
                            } catch (_) {
                                // Network or parse error  fall back to built-in if available
                                console.error('[loadLessonsForTrack] Exception loading Java lessons');
                                this.lessons = [];
                            }
                        }

                        const seen = new Set();
                        const curTrack = (track === 'python') ? 'python' : 'java';
                        console.log('[loadLessonsForTrack] Before deduplication:', this.lessons.length, 'lessons');
                        this.lessons = (this.lessons || []).filter(l => {
                            const lang = (l.language ? String(l.language) : curTrack).toLowerCase();
                            const key = `${lang}:${l.id}`;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        });
                        console.log('[loadLessonsForTrack] After deduplication:', this.lessons.length, 'lessons for', track);
                        console.log('[loadLessonsForTrack] Final sample lesson:', this.lessons[0]?.id, this.lessons[0]?.title, this.lessons[0]?.language);
                    } catch (e) {
                        console.error('[loadLessonsForTrack] Exception:', e);
                        this.showToast('Failed loading lessons for course', 'error');
                    } finally {
                        // Ensure valid lesson index
                        if (!this.lessons || this.lessons.length === 0) {
                            this.currentLessonIndex = 0;
                        } else if (this.currentLessonIndex < 0 || this.currentLessonIndex >= this.lessons.length) {
                            this.currentLessonIndex = 0;
                        }
                        if (this.elements && this.elements.lessonList) {
                            // Update dynamic tag options based on loaded lessons
                            this.refreshTagFilterOptions();
                            this.initTagFilter();
                            this.populateLessonSidebar();
                            // Don't load lesson here - let the caller decide
                            // This prevents double-loading when switching tracks
                        }
                    }
                }

                validateLessonsList(list, trackLabel = '') {
                    try {
                        const issues = [];
                        const seen = new Set();
                        (list || []).forEach((l, idx) => {
                            const lang = (l && l.language) ? String(l.language).toLowerCase() : (trackLabel || '').toLowerCase();
                            const idPart = (l && typeof l.id !== 'undefined') ? String(l.id) : `idx${idx}`;
                            const key = `${lang || 'course'}:${idPart}`;
                            if (seen.has(key)) issues.push(`Duplicate lesson id ${key}`); else seen.add(key);
                            if (!l || typeof l !== 'object') { issues.push(`Invalid lesson at index ${idx}`); return; }
                            if (typeof l.id === 'undefined') issues.push(`Lesson at index ${idx} missing id`);
                            if (!l.title) issues.push(`Lesson ${key} missing title`);
                            if (!l.description) issues.push(`Lesson ${key} missing description`);
                            if (!l.initialCode) issues.push(`Lesson ${key} missing initialCode`);
                            if (!('expectedOutput' in l) || !l.expectedOutput) issues.push(`Lesson ${key} missing expectedOutput`);
                            if (!('tutorial' in l) || !l.tutorial) issues.push(`Lesson ${key} missing tutorial`);
                        });
                        return issues;
                    } catch (_) {
                        return [];
                    }
                }

                saveState(silent = false) {
                    if (!this.isDbReady) return;
                    const state = {
                        currentLessonIndex: this.currentLessonIndex,
                        userCode: this.userCode,
                        lessonCompletion: this.lessonCompletion
                    };
                    
                    this.debouncedSave(state, silent);
                }
                
                debouncedSave(state, silent) {
                    clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(() => {
                        this.storageService.saveData(state);
                        if (!silent) {
                            this.showToast('Progress saved!', 'info');
                        }
                    }, 1500);
                }

                loadStateFromDb(state) {
                    if (state) {
                        this.currentLessonIndex = state.currentLessonIndex || 0;
                        this.userCode = state.userCode || {};
                        this.lessonCompletion = state.lessonCompletion || {};
                        console.log('[loadStateFromDb] Loaded saved state, lesson index:', this.currentLessonIndex);
                    } else {
                        this.currentLessonIndex = 0;
                        this.userCode = {};
                        this.lessonCompletion = {};
                        console.log('[loadStateFromDb] No saved state, starting at lesson 0');
                    }
                    this.loadLesson(this.currentLessonIndex, {isReload: true});
                    this.populateLessonSidebar();
                }

                askQuickQuestion(question) {
                    this.elements.aiInput.value = question;
                    this.elements.aiInput.style.height = 'auto';
                    this.elements.aiInput.style.height = (this.elements.aiInput.scrollHeight) + 'px';
                    this.handleAIChat();
                }

                async handleAIChat() {
                    const userPrompt = this.elements.aiInput.value;
                    if (!userPrompt.trim()) return;
                    this.addMessageToChat('user', userPrompt);
                    this.elements.aiInput.value = '';
                    this.elements.aiInput.style.height = 'auto';
                    this.setAIStatus('thinking');
                    this.showAITypingIndicator();

                    try {
                        const lessonContext = this.lessons[this.currentLessonIndex];

                        // Decide language context from current lesson (fallback to selected track)
                        const lessonLang = (lessonContext && lessonContext.language) ? String(lessonContext.language).toLowerCase() : (this.currentTrack || 'java');
                        const fenceLang = lessonLang === 'python' ? 'python' : 'java';

                        // Build a focused system prompt with richer lesson context
                        const expected = (lessonContext && lessonContext.expectedOutput) ? `\nExpected Output (exact match):\n\n\`\`\`\n${lessonContext.expectedOutput}\n\`\`\`\n` : '';
                        const isPy = fenceLang === 'python';
                        const systemPrompt = [
                            isPy ? "You are an expert and encouraging Python tutor for the 'devbootLLM' learning app." : "You are an expert and encouraging Java tutor for the 'devbootLLM' learning app.",
                            "Guide the student with hints and reasoning, not final solutions.",
                            "Always answer in concise Markdown with helpful headings and bullet points.",
                            `Use fenced code blocks with language tags, e.g., \`\`\`${fenceLang} ...\`\`\`.`,
                            "",
                            `Lesson: ${lessonContext.id}. ${lessonContext.title}`,
                            `Description: ${lessonContext.description}`,
                            expected,
                            isPy ? "Constraints: Python runner has a ~10s timeout; prefer simple, efficient examples." : "Constraints: Java runs with -Xmx64m and a ~10s timeout; prefer simple, efficient examples.",
                            "Policy: Do NOT paste the full final solution. Point the student to the next step instead."
                        ].filter(Boolean).join('\n');

                        // User message: their question + current code
                        const userMsg = [
                            `Question: ${userPrompt}`,
                            "",
                            "Student's current code:",
                            "",
                            `\`\`\`${fenceLang}`,
                            this.editor.getValue(),
                            "```"
                        ].join('\n');

                        // Keep short conversational memory
                        if (this.chatHistory.length > 8) {
                            this.chatHistory = this.chatHistory.slice(-8);
                        }
                        // Persist only the user message + later the model reply
                        this.chatHistory.push({ role: "user", parts: [{ text: userMsg }] });

                        // For the provider call, prepend a system message to give richer context
                        const requestHistory = [
                            { role: 'system', parts: [{ text: systemPrompt }] },
                            ...this.chatHistory
                        ];

                        const provider = (this.elements.aiProvider && this.elements.aiProvider.value) || localStorage.getItem(`aiProvider-${this.currentTrack}`) || 'ollama';
                        const model = (this.elements.aiModel && this.elements.aiModel.value) ? this.elements.aiModel.value : '';

                        if (provider === 'lmstudio') {
                            // Streaming path for LM Studio
                            const resp = await fetch('/lmstudio/chat/stream', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ model, history: requestHistory })
                            });
                            if (!resp.ok || !resp.body) throw new Error(`lmstudio API Error: ${resp.status} ${resp.statusText}`);
                            // Prepare streaming bubble with separate Thinking/Answer
                            this.hideAITypingIndicator();
                            const bubble = this.createAIResponseBubble();
                            const reader = resp.body.getReader();
                            const decoder = new TextDecoder();
                            let acc = '';
                            const pump = async () => {
                                while (true) {
                                    const { value, done } = await reader.read();
                                    if (done) break;
                                    const chunk = decoder.decode(value, { stream: true });
                                    acc += chunk;
                                    this.updateAIResponseBubble(bubble, acc);
                                    this.elements.aiChat.scrollTop = this.elements.aiChat.scrollHeight;
                                }
                            };
                            await pump();
                            const aiResponseText = acc || "";
                            this.chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                        } else {
                            // Streaming path for Ollama
                            const resp = await fetch('/ollama/chat/stream', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ model, history: requestHistory })
                            });
                            if (!resp.ok || !resp.body) throw new Error(`ollama API Error: ${resp.status} ${resp.statusText}`);
                            // Prepare streaming bubble with separate Thinking/Answer
                            this.hideAITypingIndicator();
                            const bubble = this.createAIResponseBubble();
                            const reader = resp.body.getReader();
                            const decoder = new TextDecoder();
                            let acc = '';
                            const pump = async () => {
                                while (true) {
                                    const { value, done } = await reader.read();
                                    if (done) break;
                                    const chunk = decoder.decode(value, { stream: true });
                                    acc += chunk;
                                    this.updateAIResponseBubble(bubble, acc);
                                    this.elements.aiChat.scrollTop = this.elements.aiChat.scrollHeight;
                                }
                            };
                            await pump();
                            const aiResponseText = acc || "";
                            this.chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                        }
                    } catch (error) {
                        console.error("Error calling AI provider:", error);
                        this.hideAITypingIndicator();
                        const provider = (this.elements.aiProvider && this.elements.aiProvider.value) || localStorage.getItem('aiProvider') || 'ollama';
                        if (provider === 'lmstudio') {
                            this.addMessageToChat('ai', 'There was an error connecting to LM Studio. Ensure LM Studio server is running at http://127.0.0.1:1234 and a model is loaded.');
                        } else {
                            this.addMessageToChat('ai', 'There was an error connecting to the local AI (Ollama). Ensure Ollama is running and a model is available.');
                        }
                    } finally {
                        this.setAIStatus('idle');
                    }
                }

                setAIStatus(status) {
                    const { aiAskBtn, aiInput, aiAskIcon } = this.elements;
                    if (status === 'thinking') {
                        aiAskBtn.disabled = true;
                        aiInput.disabled = true;
                        aiAskIcon.className = 'fa-solid fa-spinner fa-spin';
                    } else {
                        aiAskBtn.disabled = false;
                        aiInput.disabled = false;
                        aiAskIcon.className = 'fa-solid fa-paper-plane';
                        aiInput.focus();
                    }
                }
                
                showAITypingIndicator() {
                    const indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'chat-bubble p-3 rounded-lg bg-gemini-bg-tertiary self-start';
                    indicator.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
                    this.elements.aiChat.appendChild(indicator);
                    this.elements.aiChat.scrollTop = this.elements.aiChat.scrollHeight;
                }

                hideAITypingIndicator() {
                    const indicator = document.getElementById('typing-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }

                // --- AI Thinking/Answer helpers ---
                isAggressiveThinkingMode() {
                    try {
                        const force = localStorage.getItem('aggressiveThinking');
                        if (force === '1' || force === 'true') return true;
                    } catch (_) {}
                    const provider = (this.elements.aiProvider && this.elements.aiProvider.value) || localStorage.getItem(`aiProvider-${this.currentTrack}`) || '';
                    const model = (this.elements.aiModel && this.elements.aiModel.value) || '';
                    const m = String(model).toLowerCase();
                    const p = String(provider).toLowerCase();
                    // Be extra-helpful for Nemotron-like models which often emit verbose preambles
                    if (m.includes('nemotron') || m.includes('r1') || m.includes('deepseek') || m.includes('reason') || m.includes('think')) return true;
                    // Some providers might not carry role metadata; allow opting in per provider if desired
                    if (p.includes('ollama') && (m === '' )) return true;
                    return false;
                }

                splitThinkingAndAnswer(text) {
                    try {
                        const t = String(text || '');
                        const aggressive = !!this.isAggressiveThinkingMode();
                        const open = t.indexOf('<think>');
                        const close = t.indexOf('</think>');
                        if (open !== -1 && close !== -1 && close > open) {
                            const thinking = t.slice(open + 7, close).trim();
                            const answer = (t.slice(0, open) + t.slice(close + 8)).trim();
                            return { thinking, answer, hasThinking: thinking.length > 0 };
                        }
                        if (open !== -1 && close === -1) {
                            // Streaming and we haven't seen the closing tag yet
                            const thinking = t.slice(open + 7).trim();
                            const answer = t.slice(0, open).trim();
                            return { thinking, answer, hasThinking: true };
                        }
                        // Label-prefixed reasoning (e.g., "Thinking:", "Reasoning:", "Effects:") with optional markdown decoration
                        const labelHead = t.match(/^\s*(?:[*_`>\-]{0,3})?(?:Thinking|Thoughts?|Chain\s*of\s*Thought|CoT|Thought\s*Process|Reason|Reason(?:ing)?|Analysis|Analyses|Note|Notes|Meta|System|Effect(?:s)?|Side\s*Effect(?:s)?|Observation(?:s)?|Rationale)\s*[:\-]\s*/i);
                        if (labelHead) {
                            const body = t.slice(labelHead[0].length);
                            const anchors = [];
                            const pushIdx = (i) => { if (i !== -1) anchors.push(i); };
                            // Double newline (support both \n\n and \r\n\r\n)
                            const dblNl = body.search(/(?:\r?\n){2}/);
                            pushIdx(dblNl);
                            pushIdx(body.indexOf('```'));
                            pushIdx(body.search(/\r?\n\s*#{1,6}\s/));
                            pushIdx(body.search(/\r?\n\s*(Final\s*Answer|Answer|Solution|Steps?|Summary|In\s+Summary|In\s+Short|TL;DR)\s*[:\-]/i));
                            const anchor = anchors.filter(i => i >= 0).sort((a,b)=>a-b)[0] ?? -1;
                            if (anchor > 0) {
                                const thinking = body.slice(0, anchor).trim();
                                const answer = body.slice(anchor).trim();
                                if (thinking.length > 0) return { thinking, answer, hasThinking: true };
                            } else {
                                // Fallback: split after first 12 sentences
                                const sentenceEnd = (() => {
                                    const re = /([.!?])\s+/g; let m2, ends = []; let count = 0;
                                    while ((m2 = re.exec(body)) && count < 2) { ends.push(re.lastIndex); count++; }
                                    return ends.length ? ends[ends.length - 1] : -1;
                                })();
                                let cut = sentenceEnd > 0 ? sentenceEnd : Math.min(aggressive ? 240 : 400, body.length);
                                const fencePos = body.indexOf('```');
                                if (fencePos !== -1 && fencePos < cut) cut = fencePos;
                                const thinking = body.slice(0, cut).trim();
                                const answer = body.slice(cut).trim();
                                if (thinking.length > (aggressive ? 4 : 0)) return { thinking, answer, hasThinking: true };
                            }
                        }

                        // Non-leading label (e.g., some models prepend a short preface before "Effects:" etc.)
                        const nearLabelRe = /(?:^|[>\-*`\s]{0,5})(Thinking|Thoughts?|Chain\s*of\s*Thought|CoT|Reason(?:ing)?|Effects?|Side\s*Effects?|Analysis|Notes?|Rationale)\s*[:\-]\s*/i;
                        const nearLabelIdx = t.search(nearLabelRe);
                        if (nearLabelIdx >= 0 && nearLabelIdx <= 200) {
                            const body = t.slice(nearLabelIdx).replace(nearLabelRe, '');
                            const anchors = [];
                            const pushIdx2 = (i) => { if (i !== -1) anchors.push(i); };
                            pushIdx2(body.search(/(?:\r?\n){2}/));
                            pushIdx2(body.indexOf('```'));
                            pushIdx2(body.search(/\r?\n\s*#{1,6}\s/));
                            pushIdx2(body.search(/\r?\n\s*(Final\s*Answer|Answer|Solution|Steps?|Summary|In\s+Summary|In\s+Short|TL;DR)\s*[:\-]/i));
                            const anchor2 = anchors.filter(i => i >= 0).sort((a,b)=>a-b)[0] ?? -1;
                            if (anchor2 > 0) {
                                return { thinking: t.slice(0, nearLabelIdx).trim() + (body.slice(0, anchor2).trim() ? ('\n' + body.slice(0, anchor2).trim()) : ''),
                                         answer: body.slice(anchor2).trim(), hasThinking: true };
                            } else {
                                // Fallback: treat everything from nearLabel as thinking until we see answer cues
                                return { thinking: t, answer: '', hasThinking: true };
                            }
                        }
                        // Additional heuristic set for narrative introspection at the start.
                        // Goal: treat the initial narrative as thinking even without explicit blank lines.
                        const isIntro = /^(\s*)(ok(?:ay)?\b|alright\b|hmm\b|let(?:'s| us)\s+(?:see|think)\b|let me (?:think|check)\b|i (?:think|will|am going to|should)\b|we (?:need|should)\b|maybe\b)/i.test(t);
                        if (isIntro) {
                            // Identify anchors that often start the actual answer
                            const anchors = [];
                            const pushIdx = (i) => { if (i !== -1) anchors.push(i); };
                            // Double newline tolerant of CRLF
                            pushIdx(t.search(/(?:\r?\n){2}/));
                            pushIdx(t.indexOf('```')); // code fence
                            pushIdx(t.search(/\r?\n\s*#{1,6}\s/)); // markdown heading
                            pushIdx(t.search(/\r?\n\s*(Final\s*Answer|Answer|Solution|Steps?|Summary|In\s+Summary|In\s+Short|TL;DR)\s*[:\-]/i));
                            const anchorIdx = anchors.filter(i => i >= 0).sort((a,b)=>a-b)[0] ?? -1;

                            if (anchorIdx > 0) {
                                const thinking = t.slice(0, anchorIdx).trim();
                                const answer = t.slice(anchorIdx).trim();
                                if (thinking.length >= (aggressive ? 4 : 8)) {
                                    return { thinking, answer, hasThinking: true };
                                }
                            } else {
                                // No clear anchor; split after first 12 sentences or up to 400 chars
                                const sentenceEnd = (() => {
                                    const re = /([.!?])\s+/g; let m, ends = []; let count = 0;
                                    while ((m = re.exec(t)) && count < 2) { ends.push(re.lastIndex); count++; }
                                    return ends.length ? ends[ends.length - 1] : -1;
                                })();
                                let cut = sentenceEnd > 0 ? sentenceEnd : Math.min(aggressive ? 240 : 400, t.length);
                                // Avoid cutting into code fence
                                const fencePos = t.indexOf('```');
                                if (fencePos !== -1 && fencePos < cut) cut = fencePos;
                                const thinking = t.slice(0, cut).trim();
                                const answer = t.slice(cut).trim();
                                if (thinking.length >= (aggressive ? 4 : 8)) {
                                    return { thinking, answer, hasThinking: true };
                                }
                            }
                        }

                        // Final aggressive fallback: if model-specific mode enabled, take first sentence as thinking
                        if (aggressive) {
                            const re = /([.!?])\s+/g; const m = re.exec(t);
                            if (m && m.index > 0) {
                                const cut = re.lastIndex;
                                const thinking = t.slice(0, cut).trim();
                                const answer = t.slice(cut).trim();
                                if (thinking.length > 0) return { thinking, answer, hasThinking: true };
                            }
                        }
                        return { thinking: '', answer: t.trim(), hasThinking: false };
                    } catch (_) {
                        const safe = String(text || '').trim();
                        return { thinking: '', answer: safe, hasThinking: false };
                    }
                }

                createAIResponseBubble() {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chat-bubble markdown-body p-3 rounded-lg text-sm flex flex-col max-w-[90%] w-fit bg-gemini-bg-tertiary self-start items-start';

                    const details = document.createElement('details');
                    details.className = 'ai-thinking-details rounded-md border gemini-border gemini-bg-secondary mb-2';
                    // collapsed by default; omit details.open
                    details.innerHTML = `
                        <summary class="cursor-pointer select-none text-xs uppercase tracking-wide text-gray-400 flex items-center gap-2 py-1 px-2 hover:text-gray-200">
                            <i class="fa-regular fa-lightbulb"></i>
                            Thinking
                        </summary>
                        <div class="ai-thinking markdown-body text-gray-300 text-sm px-2 pb-2 pt-1"></div>
                    `;

                    const answer = document.createElement('div');
                    answer.className = 'ai-answer markdown-body text-base';

                    wrapper.appendChild(details);
                    wrapper.appendChild(answer);
                    this.elements.aiChat.appendChild(wrapper);
                    this.elements.aiChat.scrollTop = this.elements.aiChat.scrollHeight;
                    return wrapper;
                }

                updateAIResponseBubble(bubbleEl, fullText) {
                    if (!bubbleEl) return;
                    const { thinking, answer, hasThinking } = this.splitThinkingAndAnswer(fullText || '');
                    const details = bubbleEl.querySelector('.ai-thinking-details');
                    const thinkEl = bubbleEl.querySelector('.ai-thinking');
                    const ansEl = bubbleEl.querySelector('.ai-answer');
                    if (details && thinkEl) {
                        if (hasThinking) {
                            details.classList.remove('hidden');
                            thinkEl.innerHTML = this.renderMarkdown(thinking);
                        } else {
                            details.classList.add('hidden');
                            thinkEl.innerHTML = '';
                        }
                    }
                    if (ansEl) {
                        ansEl.innerHTML = this.renderMarkdown(answer);
                    }
                    this.postProcessMarkdownBubble(bubbleEl);
                }

                renderWelcomeChat() {
                    const currentLesson = this.lessons[this.currentLessonIndex];
                    const lessonInfo = currentLesson ? `**Lesson ${currentLesson.id}: ${currentLesson.title}**` : '';

                    const welcomeMessage = [
                        lessonInfo ? `Hi! I'm your AI tutor for ${lessonInfo}` : "Hi! I'm your AI assistant!",
                        "\n\n",
                        "I can help you with:",
                        "\n",
                        "-  **Hints** when you're stuck",
                        "\n",
                        "-  **Debugging** your code",
                        "\n",
                        "-  **Explaining** concepts",
                        "\n",
                        "-  **Best practices** and patterns",
                        "\n\n",
                        "**Remember:** I'll guide you, not give you the answer! Use the quick action buttons below to get started.",
                        "\n\n",
                        "*Tip: For faster responses, try **NVIDIA-Nemotron-Nano-12B-v2-GGUF** via [LM Studio](https://lmstudio.ai).*"
                    ].join("");
                    const html = this.renderMarkdown(welcomeMessage);
                    this.elements.aiChat.innerHTML = `<div class=\"chat-bubble markdown-body p-3 rounded-lg bg-gemini-bg-tertiary self-start mr-auto\">${html}</div>`;
                }

                clearChat() {
                    this.chatHistory = [];
                    this.hideAITypingIndicator();
                    this.renderWelcomeChat();
                    if (this.elements.aiInput) {
                        this.elements.aiInput.value = '';
                        this.elements.aiInput.style.height = 'auto';
                        this.elements.aiInput.focus();
                    }
                    this.showToast('Chat cleared', 'info');
                }

                addMessageToChat(sender, message) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chat-bubble markdown-body p-3 rounded-lg text-sm flex flex-col max-w-[90%] w-fit';
                    
                    const html = this.renderMarkdown(message || '');

                    if (sender === 'user') {
                        wrapper.classList.add('bg-[#3c4043]', 'self-end', 'items-end');
                    } else {
                        wrapper.classList.add('bg-gemini-bg-tertiary', 'self-start', 'items-start');
                    }
                    wrapper.innerHTML = html;
                    this.postProcessMarkdownBubble(wrapper);
                    

                    this.elements.aiChat.appendChild(wrapper);
                    this.elements.aiChat.scrollTop = this.elements.aiChat.scrollHeight;
                }

                getStorageKey() {
                    return `devbootllm-${this.currentTrack}-progress`;
                }

                initCourseSelect() {
                    const sel = this.elements.courseSelect;
                    if (!sel) return;
                    const options = [
                        { value: 'java', label: 'Java' },
                        { value: 'python', label: 'Python' }
                    ];
                    sel.innerHTML = '';
                    options.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o.value; opt.textContent = o.label;
                        sel.appendChild(opt);
                    });
                    sel.value = (this.currentTrack === 'python') ? 'python' : 'java';
                    sel.addEventListener('change', async () => {
                        await this.switchCourse(sel.value);
                    });
                }

                updateCourseTitle() {
                    const el = this.elements.courseTitle;
                    if (!el) return;
                    el.textContent = this.currentTrack === 'python' ? 'Python Fundamentals' : 'Java Fundamentals';
                }

                async switchCourse(track) {
                    console.log('[switchCourse] Switching to:', track);
                    if (track !== 'python' && track !== 'java') return;
                    if (this.currentTrack === track) return;
                    // Persist selection
                    this.currentTrack = track;
                    localStorage.setItem('courseTrack', track);
                    console.log('[switchCourse] Set currentTrack to:', this.currentTrack);
                    // Keep the course dropdown in sync when switched programmatically
                    if (this.elements && this.elements.courseSelect) {
                        this.elements.courseSelect.value = this.currentTrack;
                    }
                    this.updateCourseTitle();
                    // Update lesson filter dropdown to this course's saved preference
                    this.initLessonFilter();
                    // Update lesson search field to this course's saved query
                    this.initLessonSearch();
                    // Re-init provider and model selections per course
                    this.initProviderSelect();
                    await this.initOllamaModels();
                    // Point storage to the new track key and load saved state for it
                    if (this.storageService) {
                        this.storageService.storageKey = this.getStorageKey();
                        console.log('[switchCourse] Updated storage key to:', this.storageService.storageKey);
                    }
                    // Load lessons for the track
                    await this.loadLessonsForTrack(track);
                    console.log('[switchCourse] After loadLessonsForTrack, lessons count:', this.lessons.length);
                    // Load saved state for this track (if any)
                    if (this.storageService && typeof this.storageService.loadData === 'function') {
                        this.storageService.loadData();
                    } else {
                        // Fallback: reset
                        this.loadStateFromDb(null);
                    }
                    // Reset chat state for the new course
                    this.chatHistory = [];
                    // Reset chat header
                    this.renderWelcomeChat();
                    this.showToast(`Switched to ${track === 'python' ? 'Python' : 'Java'} course`, 'info');
                }

                renderMarkdown(text) {
                    try {
                        if (!this._markedConfigured) {
                            marked.setOptions({ gfm: true, breaks: true, headerIds: false });
                            this._markedConfigured = true;
                        }
                        const rawHtml = marked.parse(text || '');
                        const clean = DOMPurify.sanitize(rawHtml, { USE_PROFILES: { html: true } });
                        return clean;
                    } catch (_) {
                        const escape = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        return `<p>${escape(text || '')}</p>`;
                    }
                }

                postProcessMarkdownBubble(bubbleEl) {
                    bubbleEl.querySelectorAll('pre').forEach(pre => {
                        const code = pre.querySelector('code');
                        if (code) {
                            try { hljs.highlightElement(code); } catch (_) {}
                        }
                        if (!pre.parentElement.classList.contains('code-block-wrapper')) {
                            const wrap = document.createElement('div');
                            wrap.className = 'code-block-wrapper';
                            pre.parentElement.insertBefore(wrap, pre);
                            wrap.appendChild(pre);
                            this.addCopyToCodeBlock(wrap, pre.textContent || '');
                        }
                    });
                }

                addCopyToCodeBlock(wrapper, code) {
                    const btn = document.createElement('button');
                    btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy';
                    btn.className = 'code-block-copy-btn';
                    btn.onclick = () => {
                        const textarea = document.createElement('textarea');
                        textarea.value = code;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        this.showToast('Code copied to clipboard!');
                    };
                    wrapper.appendChild(btn);
                }

                clearConsole(isManual = false) {
                    this.elements.consoleOutput.innerHTML = '';
                    if (isManual) {
                        this.logToConsole('Console cleared.', 'info');
                    }
                }

                logToConsole(message, type = 'info', addNewLine = true) {
                    const { consoleOutput } = this.elements;
                    const MAX_LOGS = 100;
                    
                    while (consoleOutput.children.length >= MAX_LOGS) {
                        consoleOutput.removeChild(consoleOutput.firstChild);
                    }

                    let line;
                    let lastLine = consoleOutput.lastChild;
                    let isContinuingLine = !addNewLine && lastLine && lastLine.dataset.type === type;

                    if (isContinuingLine) {
                        line = lastLine;
                    } else {
                        line = document.createElement('div');
                        line.className = 'flex flex-row';
                        line.dataset.type = type;
                        
                        if (type === 'user-output' || type === 'system-output') {
                            const prompt = document.createElement('span');
                            prompt.className = 'text-gray-500 mr-2 select-none';
                            prompt.textContent = '>';
                            line.appendChild(prompt);
                        } else {
                            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            const timeEl = document.createElement('span');
                            timeEl.className = 'text-gray-500 mr-2 flex-shrink-0 select-none';
                            timeEl.textContent = timestamp;
                            line.appendChild(timeEl);
                        }
                        consoleOutput.appendChild(line);
                    }

                    const msgSpan = document.createElement('span');
                    if (String(message).includes('\n')) {
                        msgSpan.innerHTML = `<pre class="whitespace-pre-wrap">${message}</pre>`;
                    } else {
                        msgSpan.textContent = message;
                    }

                    let typeClass = 'text-gray-300';
                    switch(type) {
                        case 'success': typeClass = 'text-emerald-400'; break;
                        case 'error': typeClass = 'text-rose-400'; break;
                        case 'user-output': typeClass = 'text-cyan-300'; break;
                        case 'system-output': typeClass = 'text-sky-400'; break;
                    }
                    msgSpan.className = typeClass;
                    
                    if (isContinuingLine) {
                        const lastMsgSpan = line.querySelector('span:last-child');
                        if (lastMsgSpan) {
                            lastMsgSpan.innerHTML += message;
                        }
                    } else {
                        line.appendChild(msgSpan);
                    }

                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
                
                showToast(message, type = 'success') {
                    const toast = document.createElement('div');
                    let iconHtml = '';
                    let colors = '';

                    if (type === 'success') {
                        iconHtml = '<i class="fa-solid fa-check-circle mr-2"></i>';
                        colors = 'bg-emerald-500 text-white';
                    } else if (type === 'info') {
                        iconHtml = '<i class="fa-solid fa-info-circle mr-2"></i>';
                        colors = 'bg-sky-500 text-white';
                    } else if (type === 'error') {
                        iconHtml = '<i class="fa-solid fa-times-circle mr-2"></i>';
                        colors = 'bg-rose-500 text-white';
                    }

                    toast.className = `flex items-center p-3 rounded-lg shadow-lg text-sm font-semibold ${colors} toast-in`;
                    toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                    
                    this.elements.toastContainer.appendChild(toast);

                    setTimeout(() => {
                        toast.classList.remove('toast-in');
                        toast.classList.add('toast-out');
                        toast.addEventListener('animationend', () => toast.remove());
                    }, 3000);
                }

                setDbStatus(status, text) {
                    const { dbStatusLight, dbStatusText } = this.elements;
                    dbStatusLight.classList.remove('bg-yellow-500', 'bg-emerald-500', 'bg-rose-500', 'bg-sky-500', 'animate-pulse');
                    
                    switch(status) {
                        case 'connecting':
                            dbStatusLight.classList.add('bg-yellow-500', 'animate-pulse');
                            break;
                        case 'syncing':
                            dbStatusLight.classList.add('bg-sky-500', 'animate-pulse');
                            break;
                        case 'connected':
                            dbStatusLight.classList.add('bg-emerald-500');
                            break;
                        case 'error':
                             dbStatusLight.classList.add('bg-rose-500');
                            break;
                    }
                    dbStatusText.textContent = text;
                }

                triggerConfetti() {
                    const canvas = this.elements.confettiCanvas;
                    const ctx = canvas.getContext('2d');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    const particleCount = 150;
                    const colors = ["#8b5cf6", "#a78bfa", "#ddd6fe", "#f59e0b", "#34d399"];

                    if (this.confettiParticles.length > 0) return;

                    for (let i = 0; i < particleCount; i++) {
                        this.confettiParticles.push(this.createParticle(canvas.width, canvas.height, colors));
                    }

                    const animate = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        this.confettiParticles.forEach((p, i) => {
                            p.x += p.vx;
                            p.y += p.vy;
                            p.opacity -= 0.01;
                            
                            if (p.opacity <= 0) {
                                this.confettiParticles.splice(i, 1);
                            } else {
                                ctx.globalAlpha = p.opacity;
                                ctx.fillStyle = p.color;
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        });

                        if (this.confettiParticles.length > 0) {
                            requestAnimationFrame(animate);
                        } else {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }
                    }
                    animate();
                }

                createParticle(w, h, colors) {
                    return {
                        x: Math.random() * w,
                        y: -20,
                        vx: Math.random() * 4 - 2,
                        vy: Math.random() * 3 + 2,
                        size: Math.random() * 6 + 2,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        opacity: 1
                    };
                }
            }

            // --- View Navigation and App Initialization ---
            const landingPageView = document.getElementById('landing-page-view');
            const learningPageView = document.getElementById('learning-page-view');
            const startJavaCourseBtn = document.getElementById('start-java-course-btn');
            const startPythonCourseBtn = document.getElementById('start-python-course-btn');
            const startJourneyBtn = document.getElementById('start-journey-btn');
            const homeLink = document.getElementById('home-link');
            let learningApp = null;

            function showLearningPage(track) {
                landingPageView.classList.add('fade-out');
                setTimeout(() => {
                    landingPageView.classList.add('hidden');
                    landingPageView.classList.remove('fade-out');
                    learningPageView.classList.remove('hidden');
                    learningPageView.classList.add('fade-in');
                    if (track === 'java' || track === 'python') {
                        try { localStorage.setItem('courseTrack', track); } catch (_) {}
                    }
                    if (!learningApp) {
                        learningApp = new LearningAppController();
                        learningApp.init();
                    } else if (track && (learningApp.currentTrack !== track)) {
                        learningApp.switchCourse(track);
                    }
                }, 300);
            }

            function showLandingPage() {
                learningPageView.classList.add('fade-out');
                 setTimeout(() => {
                    learningPageView.classList.add('hidden');
                    learningPageView.classList.remove('fade-out');
                    landingPageView.classList.remove('hidden');
                    landingPageView.classList.add('fade-in');
                }, 300);
            }

            startJavaCourseBtn.addEventListener('click', () => showLearningPage('java'));
            if (startPythonCourseBtn) {
                startPythonCourseBtn.addEventListener('click', () => showLearningPage('python'));
            }
            homeLink.addEventListener('click', showLandingPage);
            startJourneyBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
            });

        });
    </script>
</body>
</html>
